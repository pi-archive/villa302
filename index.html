<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Villa 302: Final Archive</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root { --neon-red: #ff3131; --neon-green: #39ff14; --msg-blue: #007aff; --msg-gray: #e9e9eb; --apple-bg: #1c1c1e; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: white; overflow: hidden; font-family: -apple-system, sans-serif; }
        
        /* [1] ì…ì¥ í™”ë©´ - í´ë¦­ ì°¨ë‹¨ ë°©ì§€ë¥¼ ìœ„í•´ z-index ìµœìƒìœ„ */
        #entry-page { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: url('villa interior.png') no-repeat center center/cover; z-index: 999999; display: flex; justify-content: center; align-items: center; }
        .lock-box { background: rgba(0,0,0,0.95); backdrop-filter: blur(25px); padding: 40px; border-radius: 35px; border: 2px solid rgba(255,255,255,0.1); width: 320px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        .user-sel-btn { flex: 1; padding: 15px; background: #111; color: white; border: 2px solid #333; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .user-sel-btn.active { border-color: var(--neon-green); color: var(--neon-green); background: rgba(57,255,20,0.2); }
        
        #pw-disp { font-size: 3rem; color: var(--neon-red); margin-bottom: 25px; height: 60px; letter-spacing: 12px; display: flex; justify-content: center; align-items: center; text-shadow: 0 0 15px var(--neon-red); font-family: 'Courier New', monospace; }
        
        .key-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .key { padding: 22px; background: rgba(255,255,255,0.1); border-radius: 12px; cursor: pointer; font-size: 1.5rem; transition: 0.1s; user-select: none; }
        .key:active { background: rgba(255,255,255,0.3); transform: scale(0.95); }

        /* [2] ë©”ì¸ ìŠ¤í…Œì´ì§€ */
        #stage { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100vw; height: 66.67vw; max-width: 150vh; max-height: 100vh; background: url('villa.png') no-repeat center center/contain; background-color: #000; z-index: 100; }
        .target { position: absolute; cursor: pointer; z-index: 110; }
        .wall-pos { top: 18%; left: 50%; width: 15%; height: 35%; } 
        .movie-pos { top: 8%; left: 63%; width: 20%; height: 15%; } 
        .cal-pos { top: 45%; left: 74%; width: 8%; height: 20%; } 
        .diary-pos { top: 52%; left: 57%; width: 13%; height: 8%; } 
        .photo-pos { top: 25%; left: 72%; width: 10%; height: 20%; } 
        .lib-pos { top: 35%; left: 35%; width: 12%; height: 25%; } 

        /* [3] ëª¨ë‹¬ ì‹œìŠ¤í…œ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; justify-content: center; align-items: center; }
        .modal-inner { background: var(--apple-bg); width: 92%; max-width: 800px; height: 85vh; border-radius: 30px; padding: 30px; overflow-y: auto; position: relative; border: 1px solid #333; }
        .close-btn { position: absolute; top: 20px; right: 30px; font-size: 2.5rem; color: #888; cursor: pointer; }

        /* ì¼ê¸°ì¥/ìº˜ë¦°ë”/ì˜í™” ìŠ¤íƒ€ì¼ ë³´ì¡´ */
        .diary-theme { background: #fff !important; color: #000 !important; }
        #diary-chat { height: calc(100% - 160px); overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
        .diary-row { display: flex; flex-direction: column; margin-bottom: 15px; }
        .msg-container { display: flex; align-items: flex-end; }
        .profile-img { width: 35px; height: 35px; border-radius: 50%; background-size: cover; background-position: center; margin: 0 10px; background-color: #eee; flex-shrink: 0; }
        .bubble { max-width: 65%; padding: 12px 16px; border-radius: 20px; font-size: 0.95rem; cursor: pointer; }
        .bubble.mine { background: var(--msg-blue); color: #fff; border-bottom-right-radius: 4px; }
        .bubble.yours { background: var(--msg-gray); color: #000; border-bottom-left-radius: 4px; }
        .comment-area { font-size: 0.8rem; color: #888; margin-top: 4px; padding-left: 55px; cursor: pointer; font-style: italic; }
        .cal-table { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: #444; }
        .cal-day { background: #fff; color: #000; min-height: 80px; padding: 5px; cursor: pointer; font-weight: bold; }
        .cal-day.today { background: #fffde7; border: 2px solid var(--neon-green); }
        .mv-card { background: #2c2c2e; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid var(--neon-red); }

        input, textarea, select { width: 100%; padding: 14px; background: #2c2c2e; border: 1px solid #3a3a3c; color: white; border-radius: 12px; margin-bottom: 10px; box-sizing: border-box; }
        .btn-send { background: var(--msg-blue); color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; cursor: pointer; font-weight: bold; }
        #sitemap-btn { position: fixed; top: 25px; left: 25px; z-index: 1100; cursor: pointer; background: rgba(255,255,255,0.1); width: 50px; height: 50px; border-radius: 12px; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
    </style>
</head>
<body>

<div id="bgm-player" style="position:fixed; top:-5000px;"><div id="player"></div></div>
<div id="sitemap-btn" onclick="openTab('sitemap')">â˜°</div>

<div id="entry-page">
    <div class="lock-box">
        <h2 style="color:white; margin-bottom:20px;">VILLA 302</h2>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button onclick="selU('í‰í™”','1231')" id="b-í‰í™”" class="user-sel-btn">í‰í™”</button>
            <button onclick="selU('ì¸ì² ','0526')" id="b-ì¸ì² " class="user-sel-btn">ì¸ì² </button>
        </div>
        <div id="pw-disp">----</div>
        <div class="key-grid">
            <script>for(let i=1; i<=9; i++) document.write(`<div class="key" onclick="press('${i}')">${i}</div>`);</script>
            <div class="key" onclick="inputPw=''; updatePw();">C</div>
            <div class="key" onclick="press('0')">0</div>
            <div class="key" style="background:var(--neon-red)" onclick="checkPw()">E</div>
        </div>
        <p style="color:#666; font-size:0.8rem; margin-top:15px;">í‚¤ë³´ë“œ ìˆ«ìí‚¤ ì…ë ¥ ê°€ëŠ¥</p>
    </div>
</div>

<div id="stage">
    <div class="target wall-pos" onclick="openTab('wall')"></div>
    <div class="target movie-pos" onclick="openTab('movie')"></div>
    <div class="target cal-pos" onclick="openTab('calendar')"></div>
    <div class="target diary-pos" onclick="openTab('diary')"></div>
    <div class="target photo-pos" onclick="openTab('gallery')"></div>
    <div class="target lib-pos" onclick="openTab('library')"></div>
</div>

<div id="main-modal" class="modal">
    <div class="modal-inner" id="modal-box">
        <span class="close-btn" onclick="closeModal()">Ã—</span>
        <div id="modal-content"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDLTGv4Z3zJUseuKw1acvHHwPzooZhXodc",
        databaseURL: "https://villa302-default-rtdb.firebaseio.com",
        projectId: "villa302",
        appId: "1:166700659009:web:18c2872914aab8b4bbf1c0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = "", targetPw = "", inputPw = "", userProfiles = {};

    // --- [ë„ì–´ë½ & í‚¤ë³´ë“œ ë¡œì§] ---
    function selU(u,p) { 
        currentUser=u; targetPw=p; inputPw=""; 
        document.querySelectorAll('.user-sel-btn').forEach(b=>b.classList.remove('active')); 
        document.getElementById('b-'+u).classList.add('active'); 
        updatePw(); 
    }
    
    function press(n) { if(currentUser==="") {alert("ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”."); return;} if(inputPw.length<4) inputPw+=n; updatePw(); }
    function updatePw() { document.getElementById('pw-disp').innerText = "*".repeat(inputPw.length).padEnd(4, "-"); }
    
    function checkPw() { 
        if(inputPw === targetPw) { 
            document.getElementById('entry-page').style.display='none'; 
            document.getElementById('sitemap-btn').style.display='flex'; 
            db.ref('profiles').on('value', s => userProfiles = s.val()||{});
        } else { 
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤."); inputPw=""; updatePw(); 
        } 
    }

    // í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
    window.addEventListener('keydown', (e) => {
        if(document.getElementById('entry-page').style.display !== 'none') {
            if(e.key >= '0' && e.key <= '9') press(e.key);
            if(e.key === 'Enter') checkPw();
            if(e.key === 'Backspace') { inputPw = inputPw.slice(0, -1); updatePw(); }
            if(e.key === 'Escape') { inputPw = ""; updatePw(); }
        }
    });

    // --- [ë‚˜ë¨¸ì§€ ëª¨ë“  ê¸°ëŠ¥ ë¡œì§ ë³´ì¡´] ---
    
    // ìº˜ë¦°ë” (2026ë…„ 2ì›” ê¸°ì¤€)
    function renderCal() {
        const now = new Date(); const y = now.getFullYear(); const m = now.getMonth(); const td = now.getDate();
        const fDay = new Date(y, m, 1).getDay(); const lDate = new Date(y, m + 1, 0).getDate();
        db.ref(`cal_vfinal/${y}_${m+1}`).on('value', s => {
            const data = s.val() || {}; let h = "";
            for(let i=0; i<fDay; i++) h += `<div class="cal-day" style="background:#f0f0f0;"></div>`;
            for(let i=1; i<=lDate; i++) {
                const isT = (i === td) ? "today" : "";
                h += `<div class="cal-day ${isT}" onclick="setCal('${y}_${m+1}_${i}')">${i}<div style="font-size:1.8rem; text-align:center;">${data[i]||''}</div></div>`;
            }
            document.getElementById('cal-list').innerHTML = h;
            document.getElementById('cal-title').innerText = `${y}ë…„ ${m+1}ì›”`;
        });
    }
    function setCal(k) { const emo = prompt("ì˜¤ëŠ˜ì˜ ì´ëª¨ì§€:"); if(emo) { const [y,m,d] = k.split('_'); db.ref(`cal_vfinal/${y}_${m}/${d}`).set(emo); } }

    // ì¼ê¸°ì¥ (ìˆ˜ì •/ì‚­ì œ/ëŒ“ê¸€)
    function addDy() { const t = document.getElementById('dy-in').value; if(t) db.ref('dy_vfinal').push({ t, u: currentUser, ts: Date.now() }); document.getElementById('dy-in').value=""; }
    function renderDy() {
        db.ref('dy_vfinal').on('value', s => {
            const d = s.val(); const div = document.getElementById('diary-chat'); if(!div || !d) return;
            div.innerHTML = Object.keys(d).map(k => {
                const isM = d[k].u === currentUser;
                return `<div class="diary-row"><div class="msg-container" style="flex-direction:${isM?'row-reverse':'row'}"><div class="profile-img" style="background-image:url('${userProfiles[d[k].u]||''}')"></div><div class="bubble ${isM?'mine':'yours'}" onclick="manageDy('${k}','${d[k].u}','${d[k].t}')">${d[k].t}</div></div><div class="comment-area" onclick="addCmt('${k}')">${d[k].cmt ? 'ğŸ’¬ '+d[k].cmt : 'ëŒ“ê¸€ ë‹¬ê¸°...'}</div></div>`;
            }).join('');
            div.scrollTop = div.scrollHeight;
        });
    }
    function manageDy(k,u,old) { if(u!==currentUser) return; const a=prompt("'ìˆ˜ì •' ë˜ëŠ” 'ì‚­ì œ'"); if(a==='ìˆ˜ì •'){const nt=prompt("ìˆ˜ì •:",old); if(nt) db.ref(`dy_vfinal/${k}`).update({t:nt});} else if(a==='ì‚­ì œ') db.ref(`dy_vfinal/${k}`).remove(); }
    function addCmt(k) { const c=prompt("ëŒ“ê¸€:"); if(c) db.ref(`dy_vfinal/${k}`).update({cmt:c}); }

    function openTab(id) {
        const box = document.getElementById('modal-box'); const content = document.getElementById('modal-content');
        box.className = (id === 'diary' ? 'modal-inner diary-theme' : 'modal-inner');
        document.getElementById('main-modal').style.display = 'flex';
        if(id === 'calendar') { content.innerHTML = `<h3 id="cal-title"></h3><div id="cal-list" class="cal-table"></div>`; renderCal(); }
        else if(id === 'diary') { content.innerHTML = `<h3>ğŸ“” DIARY</h3><div id="diary-chat"></div><div style="display:flex; gap:10px;"><textarea id="dy-in" placeholder="ë©”ì‹œì§€..."></textarea><button class="btn-send" style="width:80px;" onclick="addDy()">â†‘</button></div>`; renderDy(); }
        else if(id === 'wall') { content.innerHTML = `<h3>ğŸ§± THE WALL</h3><textarea id="wl-in"></textarea><button class="btn-send" onclick="addWl()">ë¶™ì´ê¸°</button><div id="wl-list" style="display:flex; flex-wrap:wrap; gap:10px; margin-top:20px;"></div>`; renderWl(); }
        else if(id === 'movie') { content.innerHTML = `<h3>ğŸ¬ MOVIE</h3><input id="mv-t" placeholder="ì œëª©"><textarea id="mv-r"></textarea><button class="btn-send" onclick="addMv()">ì €ì¥</button><div id="mv-list" style="margin-top:20px;"></div>`; renderMv(); }
        else if(id === 'library') { content.innerHTML = `<h3>ğŸ“š LIBRARY</h3><input id="bk-t" placeholder="ë„ì„œëª…"><button class="btn-send" onclick="addBk()">ë“±ë¡</button><div id="bk-list" style="margin-top:20px;"></div>`; renderBk(); }
        else if(id === 'gallery') { content.innerHTML = `<h3>ğŸ“¸ GALLERY</h3><input type="file" onchange="addGal(this)"><div id="gal-list" style="margin-top:20px;"></div>`; renderGal(); }
        else if(id === 'profile') { content.innerHTML = `<h3>ğŸ‘¤ PROFILE</h3><input type="file" onchange="savePf(this)">`; }
        else if(id === 'sitemap') { content.innerHTML = `<h3>SITEMAP</h3><div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">${['diary','wall','gallery','movie','calendar','library','profile'].map(t=>`<button class="btn-send" style="background:#333;" onclick="openTab('${t}')">${t.toUpperCase()}</button>`).join('')}</div>`; }
    }

    function addWl() { const t=document.getElementById('wl-in').value; if(t) db.ref('wl_vfinal').push({t, u:currentUser}); }
    function renderWl() { db.ref('wl_vfinal').on('value', s=>{ const d=s.val(); document.getElementById('wl-list').innerHTML=Object.keys(d||{}).map(k=>`<div style="background:#fff9c4; color:#333; padding:15px; width:120px; position:relative;">${d[k].t}<span onclick="db.ref('wl_vfinal/${k}').remove()" style="position:absolute; top:2px; right:5px; cursor:pointer;">Ã—</span></div>`).join(''); }); }
    function addMv() { const t=document.getElementById('mv-t').value, r=document.getElementById('mv-r').value; if(t) db.ref('mv_vfinal').push({t, r, u:currentUser}); }
    function renderMv() { db.ref('mv_vfinal').on('value', s=>{ const d=s.val(); document.getElementById('mv-list').innerHTML=Object.keys(d||{}).map(k=>`<div class="mv-card"><b>${d[k].t}</b><p>${d[k].r}</p><small>${d[k].u}</small></div>`).join(''); }); }
    function addBk() { const t=document.getElementById('bk-t').value; if(t) db.ref('bk_vfinal').push({t, u:currentUser}); }
    function renderBk() { db.ref('bk_vfinal').on('value', s=>{ const d=s.val(); document.getElementById('bk-list').innerHTML=Object.keys(d||{}).map(k=>`<div style="padding:10px; background:#333; margin-bottom:5px;">ğŸ“– ${d[k].t} (${d[k].u})</div>`).join(''); }); }
    function addGal(i) { if(i.files[0]) { const r=new FileReader(); r.onload=e=>db.ref('gal_vfinal').push({img:e.target.result, u:currentUser}); r.readAsDataURL(i.files[0]); } }
    function renderGal() { db.ref('gal_vfinal').on('value', s=>{ const d=s.val(); document.getElementById('gal-list').innerHTML=Object.keys(d||{}).map(k=>`<div style="margin-bottom:20px; border:1px solid #333;"><img src="${d[k].img}" style="width:100%"><p style="padding:10px;">By ${d[k].u}</p></div>`).join(''); }); }
    function savePf(i) { if(i.files[0]) { const r=new FileReader(); r.onload=e=>db.ref('profiles/'+currentUser).set(e.target.result).then(()=>alert("ì €ì¥ì™„ë£Œ")); r.readAsDataURL(i.files[0]); } }
    function closeModal() { document.getElementById('main-modal').style.display='none'; }
</script>
</body>
</html>