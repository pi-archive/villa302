<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Villa 302: The Archive</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        /* --- [VILLA 302 ORIGINAL DESIGN SYSTEM] --- */
        :root { 
            --neon-red: #ff3131; 
            --neon-green: #39ff14; 
            --hk-gold: #ffd700; 
            --msg-blue: #007aff; 
            --msg-gray: #e9e9eb; 
            --apple-bg: #1c1c1e;
        }

        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background: #000; color: white; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            overflow: hidden; -webkit-font-smoothing: antialiased;
        }

        /* Entry Page (Lock Screen) */
        #entry-page { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; 
            background: url('villa interior.png') no-repeat center center/cover; 
            z-index: 50000; display: flex; justify-content: center; align-items: center; 
        }
        .lock-box { 
            background: rgba(0,0,0,0.85); backdrop-filter: blur(20px); 
            padding: 40px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.1);
            width: 320px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.5);
        }
        .user-sel-btn {
            flex: 1; padding: 15px; background: rgba(255,255,255,0.05); color: white;
            border: 1px solid rgba(255,255,255,0.2); border-radius: 15px; cursor: pointer;
            font-weight: bold; transition: 0.3s;
        }
        .user-sel-btn.active { border-color: var(--neon-green); color: var(--neon-green); background: rgba(57,255,20,0.1); }

        /* Main Stage */
        #stage { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 100vw; height: 66.67vw; max-width: 150vh; max-height: 100vh; 
            background: url('villa.png') no-repeat center center/contain; background-color: #000; 
        }

        /* Targets */
        .target { position: absolute; cursor: pointer; z-index: 10; transition: 0.3s; }
        .target:hover { background: rgba(255,255,255,0.1); border-radius: 10px; }
        .wall-pos { top: 18%; left: 50%; width: 15%; height: 35%; } 
        .movie-pos { top: 8%; left: 63%; width: 20%; height: 15%; } 
        .cal-pos { top: 45%; left: 74%; width: 8%; height: 20%; } 
        .diary-pos { top: 52%; left: 57%; width: 13%; height: 8%; } 
        .photo-pos { top: 25%; left: 72%; width: 10%; height: 20%; } 
        .lib-pos { top: 35%; left: 35%; width: 12%; height: 25%; } 
        .exit-pos { top: 15%; left: 91%; width: 9%; height: 75%; } 

        /* UI Elements */
        #sitemap-btn { 
            position: fixed; top: 30px; left: 30px; width: 55px; height: 55px; 
            background: rgba(255,255,255,0.1); backdrop-filter: blur(15px); 
            border: 1px solid rgba(255,255,255,0.2); color: white; cursor: pointer; 
            z-index: 1100; border-radius: 15px; display: none; align-items: center; justify-content: center; font-size: 1.5rem; 
        }
        #user-indicator { 
            position: fixed; top: 30px; right: 30px; padding: 15px 25px; 
            background: rgba(0,0,0,0.7); backdrop-filter: blur(10px);
            border: 1px solid var(--neon-green); border-radius: 40px; 
            color: var(--neon-green); font-weight: 800; z-index: 1000; display: none; cursor: pointer;
            letter-spacing: 1px; box-shadow: 0 0 15px rgba(57,255,20,0.2);
        }

        /* Modal System */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.92); z-index: 10000; justify-content: center; align-items: center; 
        }
        .modal-inner { 
            background: var(--apple-bg); width: 92%; max-width: 800px; height: 85vh; 
            border-radius: 35px; padding: 40px; overflow-y: auto; position: relative; color: white; 
            border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 30px 60px rgba(0,0,0,0.5);
        }
        .close-btn { position: absolute; top: 25px; right: 30px; cursor: pointer; font-size: 2.8rem; color: #444; transition: 0.3s; }
        .close-btn:hover { color: #fff; }

        /* --- [1. ê³ ë„í™” ì„œì¬ CSS] --- */
        .shelf { 
            background: #3d2b1f; border: 12px solid #2a1d15; border-radius: 8px; 
            padding: 30px; display: grid; grid-template-columns: repeat(auto-fill, minmax(85px, 1fr)); 
            gap: 20px; min-height: 450px; box-shadow: inset 0 0 60px #000; align-content: start;
        }
        .book { 
            width: 75px; height: 120px; border-left: 18px solid rgba(0,0,0,0.25); border-radius: 4px; 
            position: relative; cursor: pointer; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
            display: flex; align-items: center; justify-content: center; box-shadow: 8px 8px 15px rgba(0,0,0,0.4);
        }
        .book:hover { transform: translateY(-20px) rotate(-3deg); box-shadow: 12px 20px 25px rgba(0,0,0,0.6); }
        .book-title { font-size: 0.8rem; color: #fff; text-align: center; writing-mode: vertical-rl; padding: 8px; font-weight: 500; }

        /* --- [2. ì•„ì´ë©”ì‹œì§€ ì¼ê¸°ì¥ CSS] --- */
        .diary-theme { background: #fff !important; color: #000 !important; }
        #diary-chat { height: calc(100% - 160px); overflow-y: auto; padding: 25px; display: flex; flex-direction: column; }
        .diary-row { display: flex; margin-bottom: 14px; align-items: flex-end; width: 100%; }
        .profile-pic { width: 38px; height: 38px; border-radius: 50%; background-size: cover; background-position: center; margin: 0 10px; flex-shrink: 0; background-color: #f0f0f0; }
        .bubble { 
            max-width: 72%; padding: 12px 18px; border-radius: 22px; font-size: 1rem; 
            position: relative; word-wrap: break-word; line-height: 1.45;
        }
        .bubble.mine { background: var(--msg-blue); color: #fff; margin-left: auto; border-bottom-right-radius: 4px; }
        .bubble.yours { background: var(--msg-gray); color: #000; border-bottom-left-radius: 4px; }

        /* --- [3. ìº˜ë¦°ë” & ì´ëª¨ì§€ CSS] --- */
        .cal-container { background: #fff; color: #333; border-radius: 25px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-weight: 700; font-size: 1.2rem; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: #eee; border-radius: 10px; overflow: hidden; }
        .cal-cell { background: #fff; min-height: 100px; padding: 10px; cursor: pointer; transition: 0.2s; position: relative; }
        .cal-cell:hover { background: #f9f9f9; }
        .emo-scroll-box { display: flex; gap: 12px; overflow-x: auto; padding: 15px 5px; scrollbar-width: none; }
        .emo-item { 
            flex: 0 0 auto; width: 60px; text-align: center; cursor: pointer; 
            padding: 12px; border-radius: 15px; border: 1.5px solid #eee; background: #fff; transition: 0.2s;
        }
        .emo-item.active { border-color: var(--msg-blue); background: #f0f7ff; transform: scale(1.05); }

        /* --- [4. ì¸ìŠ¤íƒ€ê·¸ë¨ ê°¤ëŸ¬ë¦¬ CSS] --- */
        .insta-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .insta-item { aspect-ratio: 1/1; background-size: cover; background-position: center; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .insta-item:hover { filter: brightness(0.8); }

        /* Profile & Common UI */
        #prof-preview { 
            width: 150px; height: 150px; border-radius: 50%; border: 5px solid var(--neon-green); 
            margin: 20px auto; background-size: cover; background-position: center; 
            box-shadow: 0 10px 25px rgba(57,255,20,0.3);
        }
        .btn-action { 
            background: var(--msg-blue); color: white; border: none; padding: 16px; 
            border-radius: 15px; cursor: pointer; width: 100%; font-weight: 700; font-size: 1rem;
            margin-top: 15px; transition: 0.3s;
        }
        .btn-action:active { transform: scale(0.98); filter: brightness(1.2); }
        input, textarea { 
            width: 100%; padding: 16px; background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.15); color: white; border-radius: 15px; 
            box-sizing: border-box; margin-bottom: 15px; font-size: 1rem;
        }
        textarea:focus { outline: none; border-color: var(--msg-blue); }
    </style>
</head>
<body onkeydown="handleGlobalKey(event)">

<div id="bgm-player" style="position: absolute; top: -1000px;"></div>
<div id="sitemap-btn" onclick="openTab('sitemap')">â˜°</div>
<div id="user-indicator" onclick="openTab('profile')">ACCESS: <span id="active-user"></span></div>

<div id="entry-page">
    <div class="lock-box">
        <h2 style="margin-top:0; color:#fff; font-size:1.2rem; letter-spacing:2px;">VILLA 302</h2>
        <div style="display:flex; gap:12px; margin-bottom:30px;">
            <button onclick="selectUser('í‰í™”','1231')" id="btn-í‰í™”" class="user-sel-btn">í‰í™”</button>
            <button onclick="selectUser('ì¸ì² ','0526')" id="btn-ì¸ì² " class="user-sel-btn">ì¸ì² </button>
        </div>
        <div id="pw-disp" style="font-size: 2.8rem; color: var(--neon-red); margin-bottom: 30px; height: 60px; font-family: 'Courier New', Courier, monospace; letter-spacing: 8px;">----</div>
        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:15px;">
            <script>for(let i=1; i<=9; i++) document.write(`<div style="padding:22px; background:rgba(255,255,255,0.05); border-radius:15px; cursor:pointer; font-size:1.2rem;" onclick="pressKey('${i}')">${i}</div>`);</script>
            <div style="padding:22px; background:rgba(255,255,255,0.05); border-radius:15px; cursor:pointer;" onclick="inputPw=''; updatePwDisp();">C</div>
            <div style="padding:22px; background:rgba(255,255,255,0.05); border-radius:15px; cursor:pointer;" onclick="pressKey('0')">0</div>
            <div style="padding:22px; background:var(--neon-red); border-radius:15px; cursor:pointer;" onclick="checkPw()">E</div>
        </div>
    </div>
</div>

<div id="stage">
    <div class="target wall-pos" onclick="openTab('wall')"></div>
    <div class="target movie-pos" onclick="openTab('movie')"></div>
    <div class="target cal-pos" onclick="openTab('calendar')"></div>
    <div class="target diary-pos" onclick="openTab('diary')"></div>
    <div class="target photo-pos" onclick="openTab('gallery')"></div>
    <div class="target lib-pos" onclick="openTab('library')"></div>
    <div class="target exit-pos" onclick="exitRoom()"></div>
</div>

<div id="main-modal" class="modal">
    <div class="modal-inner" id="modal-box">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <div id="modal-content"></div>
    </div>
</div>

<script>
    // --- [FIREBASE INITIALIZATION] ---
    const firebaseConfig = {
        apiKey: "AIzaSyDLTGv4Z3zJUseuKw1acvHHwPzooZhXodc",
        authDomain: "villa302.firebaseapp.com",
        databaseURL: "https://villa302-default-rtdb.firebaseio.com",
        projectId: "villa302",
        storageBucket: "villa302.firebasestorage.app",
        messagingSenderId: "166700659009",
        appId: "1:166700659009:web:18c2872914aab8b4bbf1c0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = "", targetPw = "", inputPw = "", tempImgData = "";
    let userProfiles = {}, currentCalDate = new Date(), selectedCalKey = "", selectedEmo = "ğŸ ";

    // --- [CORE LOGIC: LOGIN & UI] ---
    function selectUser(u, p) { 
        currentUser = u; targetPw = p; inputPw = ""; 
        document.querySelectorAll('.user-sel-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-'+u).classList.add('active');
        updatePwDisp(); 
    }
    function pressKey(n) { if(inputPw.length < 4) inputPw += n; updatePwDisp(); }
    function updatePwDisp() { document.getElementById('pw-disp').innerText = "*".repeat(inputPw.length) || "----"; }
    
    function checkPw() {
        if(inputPw === targetPw) {
            document.getElementById('entry-page').style.display='none';
            document.getElementById('user-indicator').style.display='flex';
            document.getElementById('sitemap-btn').style.display='flex';
            document.getElementById('active-user').innerText = currentUser;
            
            db.ref('profiles').on('value', s => { 
                userProfiles = s.val() || {}; 
                const preview = document.getElementById('prof-preview');
                if(preview) preview.style.backgroundImage = `url('${userProfiles[currentUser] || ''}')`;
            });
            
            loadBGM();
        } else { alert("ì•”í˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤."); inputPw=""; updatePwDisp(); }
    }

    function exitRoom() { if(confirm("ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) location.reload(); }

    function handleGlobalKey(e) { 
        // 1. ëª¨ë‹¬ ë‹«ê¸° (Esc)
        if (e.key === "Escape") closeModal(); 

        // 2. ì…ì¥ í˜ì´ì§€ í‚¤ë³´ë“œ ì…ë ¥ ë¡œì§ (ì¶”ê°€ëœ ë¶€ë¶„)
        if (document.getElementById('entry-page').style.display !== 'none') {
            if (e.key >= "0" && e.key <= "9") {
                pressKey(e.key);
            } else if (e.key === "Enter") {
                checkPw();
            } else if (e.key === "Backspace" || e.key === "c" || e.key === "C") {
                inputPw = ""; 
                updatePwDisp();
            }
        }
    }

    // --- [TAB CONTENTS & RENDERERS] ---
    const tabs = {
        sitemap: () => `<h3>SITEMAP</h3><div style="display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-top:20px;">
            <div style="background:rgba(255,255,255,0.05); padding:30px; border-radius:20px; cursor:pointer; text-align:center;" onclick="openTab('diary')"><div style="font-size:2rem; margin-bottom:10px;">ğŸ“”</div>ì¼ê¸°ì¥</div>
            <div style="background:rgba(255,255,255,0.05); padding:30px; border-radius:20px; cursor:pointer; text-align:center;" onclick="openTab('library')"><div style="font-size:2rem; margin-bottom:10px;">ğŸ“š</div>ì„œì¬</div>
            <div style="background:rgba(255,255,255,0.05); padding:30px; border-radius:20px; cursor:pointer; text-align:center;" onclick="openTab('calendar')"><div style="font-size:2rem; margin-bottom:10px;">ğŸ“…</div>ì¼ì •</div>
            <div style="background:rgba(255,255,255,0.05); padding:30px; border-radius:20px; cursor:pointer; text-align:center;" onclick="openTab('bgm_mgr')"><div style="font-size:2rem; margin-bottom:10px;">ğŸµ</div>BGM</div>
        </div>`,
        profile: () => `<h3>ğŸ‘¤ PROFILE SETTING</h3>
            <div id="prof-preview" style="background-image:url('${userProfiles[currentUser] || ''}')"></div>
            <input type="file" id="prof-in" accept="image/*" onchange="previewImg(this)" style="display:none">
            <button class="btn-action" style="background:#444" onclick="document.getElementById('prof-in').click()">ì‚¬ì§„ ì„ íƒ</button>
            <button class="btn-action" onclick="saveProfile()">í”„ë¡œí•„ ì €ì¥í•˜ê¸°</button>
            <p style="font-size:0.8rem; color:#8e8e93; text-align:center; margin-top:15px;">ì €ì¥ ì‹œ ì¼ê¸°ì¥ í”„ì‚¬ê°€ ì¦‰ì‹œ ë³€ê²½ë©ë‹ˆë‹¤.</p>`,
        library: () => `<h3>ğŸ“š VILLA ARCHIVE: LIBRARY</h3>
            <div style="background:rgba(255,255,255,0.05); padding:25px; border-radius:20px; margin-bottom:25px; border:1px solid rgba(255,255,255,0.1);">
                <input id="book-title" placeholder="ë„ì„œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" style="margin-bottom:10px;">
                <button class="btn-action" onclick="addBook()">ì±…ì¥ì— ê½‚ê¸°</button>
            </div>
            <div class="shelf" id="shelf-area"></div>`,
        diary: () => `<div id="diary-chat"></div>
            <div style="padding:20px; background:#fff; border-top:1px solid #eee; display:flex; gap:12px; align-items:center;">
                <textarea id="d-in" placeholder="iMessage" style="background:#f1f1f2; color:#000; height:48px; flex:1; border:none; margin:0; padding:12px 20px; border-radius:24px; resize:none;"></textarea>
                <button onclick="saveDiary()" style="width:48px; height:48px; background:var(--msg-blue); color:white; border:none; border-radius:50%; cursor:pointer; font-size:1.4rem; display:flex; align-items:center; justify-content:center;">â†‘</button>
            </div>`,
        calendar: () => `<h3>ğŸ“… CALENDAR</h3><div id="cal-render-area"></div>
            <div id="cal-editor" style="display:none; margin-top:25px; background:#f9f9f9; padding:25px; border-radius:20px; color:#333; border:1px solid #eee;">
                <p id="cal-date-title" style="font-weight:700; margin-top:0;"></p>
                <div class="emo-scroll-box">${[{e:"ğŸ ", l:"ì§‘"}, {e:"ğŸŸ", l:"ë°ì´íŠ¸"}, {e:"â­", l:"ì¤‘ìš”"}, {e:"ğŸ¬", l:"ì˜í™”"}, {e:"ğŸº", l:"ìˆ "}, {e:"ğŸ˜­", l:"ìš°ìš¸"}, {e:"ğŸ’¡", l:"ìƒê°"}].map(item => `<div class="emo-item" id="emo-${item.e}" onclick="selectEmo('${item.e}')"><span style="font-size:1.5rem;">${item.e}</span><br><small style="color:#666;">${item.l}</small></div>`).join('')}</div>
                <input id="cal-memo-in" placeholder="í•œ ì¤„ ë©”ëª¨..." style="background:#fff; color:#000; border:1.5px solid #ddd; margin-top:10px;">
                <button class="btn-action" onclick="saveCal()">ì˜¤ëŠ˜ì˜ ê¸°ë¡ ì €ì¥</button>
            </div>`,
        bgm_mgr: () => `<h3>ğŸµ ì‹¤ì‹œê°„ BGM ì„¤ì •</h3><p style="color:#8e8e93; font-size:0.9rem;">ìœ íŠœë¸Œ ë§í¬ë¥¼ ì…ë ¥í•˜ë©´ ë¹Œë¼ ì „ì²´ì˜ ë°°ê²½ìŒì•…ì´ ë³€ê²½ë©ë‹ˆë‹¤.</p><input id="bgm-in" placeholder="https://www.youtube.com/watch?v=..."><button class="btn-action" onclick="saveBGM()">BGM ì¦‰ì‹œ ì ìš©</button>`,
        movie: () => `<h3>ğŸ¬ MOVIE LOG</h3><input id="m-in" placeholder="ê´€ëŒí•œ ì˜í™” ì œëª©"><button class="btn-action" onclick="addMovie()">ë¦¬ìŠ¤íŠ¸ ì¶”ê°€</button><div id="m-list" style="margin-top:25px;"></div>`,
        gallery: () => `<h3>ğŸ“¸ VILLA MOMENTS</h3><input type="file" id="g-in" accept="image/*" style="display:none" onchange="uploadPhoto(this)"><button class="btn-action" style="background:#444; margin-bottom:20px;" onclick="document.getElementById('g-in').click()">ì‚¬ì§„ ì—…ë¡œë“œ</button><div id="g-list" class="insta-grid"></div>`,
        wall: () => `<h3>ğŸ§± THE WALL</h3><p style="color:#8e8e93;">ë°©ëª…ë¡ ê¸°ëŠ¥ ì—…ë°ì´íŠ¸ ì˜ˆì •ì…ë‹ˆë‹¤.</p>`
    };

    function openTab(id) {
        const box = document.getElementById('modal-box');
        id === 'diary' ? box.classList.add('diary-theme') : box.classList.remove('diary-theme');
        document.getElementById('modal-content').innerHTML = tabs[id]();
        document.getElementById('main-modal').style.display = 'flex';
        
        // ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰
        if(id==='library') loadBooks();
        if(id==='calendar') setTimeout(renderCalendar, 100);
        if(id==='diary') loadDiary();
        if(id==='movie') loadMovies();
        if(id==='gallery') loadGallery();
    }
    function closeModal() { document.getElementById('main-modal').style.display = 'none'; }

    // --- [FEATURE: LIBRARY (ì„œì¬ ê³ ë„í™”)] ---
    const bookColors = ['#8c3b3b', '#3b5a8c', '#3b8c4a', '#8c7a3b', '#6d3b8c', '#3b8c85', '#2c2c2e', '#4a4a4a'];
    function addBook() {
        const title = document.getElementById('book-title').value;
        if(!title) return;
        const color = bookColors[Math.floor(Math.random()*bookColors.length)];
        db.ref('library').push({ title, color, owner: currentUser, date: new Date().toLocaleDateString() });
        document.getElementById('book-title').value = "";
    }
    function loadBooks() {
        db.ref('library').on('value', s => {
            const shelf = document.getElementById('shelf-area'); if(!shelf) return;
            shelf.innerHTML = "";
            const data = s.val();
            if(data) Object.keys(data).forEach(key => {
                const b = data[key];
                const book = document.createElement('div');
                book.className = 'book'; book.style.backgroundColor = b.color;
                book.innerHTML = `<div class="book-title">${b.title}</div>`;
                book.onclick = () => { if(confirm(`[${b.title}]\në“±ë¡ì: ${b.owner}\në“±ë¡ì¼: ${b.date}\n\nì±…ì¥ì—ì„œ ì‚­ì œí• ê¹Œìš”?`)) db.ref('library/'+key).remove(); };
                shelf.appendChild(book);
            });
        });
    }

    // --- [FEATURE: DIARY (ì•„ì´ë©”ì‹œì§€)] ---
    function saveDiary() {
        const t = document.getElementById('d-in').value; if(!t.trim()) return;
        db.ref('diary_v2').push({ u: currentUser, t: t.trim(), ts: Date.now() });
        document.getElementById('d-in').value = "";
    }
    function loadDiary() {
        db.ref('diary_v2').on('value', s => {
            const chat = document.getElementById('diary-chat'); if(!chat) return;
            const data = s.val(); chat.innerHTML = "";
            if(data) Object.keys(data).forEach(key => {
                const i = data[key]; const isMine = i.u === currentUser;
                chat.innerHTML += `
                    <div class="diary-row" style="flex-direction:${isMine?'row-reverse':'row'}">
                        <div class="profile-pic" style="background-image:url('${userProfiles[i.u] || ''}')"></div>
                        <div class="bubble ${isMine?'mine':'yours'}" onclick="handleMsgDelete('${key}', '${i.u}')">
                            ${i.t}
                        </div>
                    </div>`;
            });
            chat.scrollTop = chat.scrollHeight;
        });
    }
    function handleMsgDelete(key, owner) {
        if(owner === currentUser && confirm("ì´ ë©”ì‹œì§€ë¥¼ ì‚­ì œí• ê¹Œìš”?")) db.ref('diary_v2/'+key).remove();
    }

    // --- [FEATURE: CALENDAR (ì´ëª¨ì§€ & ë Œë”ë§ ìˆ˜ì •)] ---
    function renderCalendar() {
        const year = currentCalDate.getFullYear(), month = currentCalDate.getMonth();
        const days = new Date(year, month + 1, 0).getDate();
        const startDay = new Date(year, month, 1).getDay();
        db.ref('cal_v3').on('value', s => {
            const data = s.val() || {};
            let html = `<div class="cal-container"><div class="cal-header"><span onclick="moveMonth(-1)" style="cursor:pointer; padding:10px;">â—€</span><span>${year}ë…„ ${month+1}ì›”</span><span onclick="moveMonth(1)" style="cursor:pointer; padding:10px;">â–¶</span></div><div class="cal-grid">`;
            ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(d => html += `<div style="text-align:center; padding:12px; font-size:0.85rem; font-weight:bold; color:#888;">${d}</div>`);
            for(let i=0; i<startDay; i++) html += `<div class="cal-cell" style="background:#fcfcfc"></div>`;
            for(let d=1; d<=days; d++) {
                const key = `${year}-${month+1}-${d}`;
                html += `<div class="cal-cell" onclick="editCal('${key}', ${d})">
                    <div style="font-size:0.85rem; font-weight:600;">${d}</div>
                    <div style="font-size:1.8rem; text-align:center; margin-top:5px;">${data[key]?.emo || ''}</div>
                    <div style="font-size:0.7rem; color:#888; text-align:center; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${data[key]?.memo || ''}</div>
                </div>`;
            }
            document.getElementById('cal-render-area').innerHTML = html + `</div></div>`;
        });
    }
    function moveMonth(n) { currentCalDate.setMonth(currentCalDate.getMonth() + n); renderCalendar(); }
    function editCal(key, d) {
        selectedCalKey = key; document.getElementById('cal-editor').style.display = 'block';
        document.getElementById('cal-date-title').innerText = d + "ì¼ì˜ ë¬´ë“œì™€ ë©”ëª¨";
        db.ref('cal_v3/'+key).once('value', s => { 
            const v = s.val() || {emo:'ğŸ ', memo:''}; 
            selectEmo(v.emo); document.getElementById('cal-memo-in').value = v.memo; 
        });
    }
    function selectEmo(e) { 
        selectedEmo = e; 
        document.querySelectorAll('.emo-item').forEach(el => el.classList.remove('active')); 
        const activeItem = document.getElementById('emo-'+e);
        if(activeItem) activeItem.classList.add('active'); 
    }
    function saveCal() { 
        db.ref('cal_v3/'+selectedCalKey).set({ 
            emo: selectedEmo, 
            memo: document.getElementById('cal-memo-in').value 
        }).then(() => {
            alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            document.getElementById('cal-editor').style.display = 'none';
        }); 
    }

    // --- [FEATURE: PROFILE & BGM (ìš”ì²­ í•µì‹¬)] ---
    function previewImg(i) { 
        if(i.files && i.files[0]) { 
            const r = new FileReader(); 
            r.onload = e => { 
                document.getElementById('prof-preview').style.backgroundImage = `url('${e.target.result}')`; 
                tempImgData = e.target.result; 
            }; 
            r.readAsDataURL(i.files[0]); 
        } 
    }
    function saveProfile() { 
        if(!tempImgData) return alert("ë³€ê²½í•  ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”."); 
        db.ref('profiles/'+currentUser).set(tempImgData).then(() => alert("í”„ë¡œí•„ ì‚¬ì§„ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")); 
    }
    
    function loadBGM() { 
        db.ref('settings/bgm').on('value', s => { 
            const id = s.val(); 
            if(id) document.getElementById('bgm-player').innerHTML = `<iframe width="0" height="0" src="https://www.youtube.com/embed/${id}?autoplay=1&loop=1&playlist=${id}" frameborder="0" allow="autoplay"></iframe>`; 
        }); 
    }
    function saveBGM() { 
        let v = document.getElementById('bgm-in').value; 
        let id = v.includes('v=') ? v.split('v=')[1].split('&')[0] : (v.includes('youtu.be/') ? v.split('youtu.be/')[1].split('?')[0] : v); 
        db.ref('settings/bgm').set(id).then(() => { alert("ë°°ê²½ìŒì•…ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤."); document.getElementById('bgm-in').value=""; }); 
    }

    // --- [FEATURE: MOVIE & GALLERY] ---
    function addMovie() { 
        const t = document.getElementById('m-in').value; if(!t) return;
        db.ref('movie_v2').push({ t, u: currentUser }); document.getElementById('m-in').value=""; 
    }
    function loadMovies() { 
        db.ref('movie_v2').on('value', s => { 
            const d = s.val(); 
            document.getElementById('m-list').innerHTML = d ? Object.values(d).reverse().map(i => `<div style="padding:15px; background:rgba(255,255,255,0.05); margin-bottom:10px; border-radius:12px; font-size:0.95rem;">ğŸ¬ ${i.t} <small style="color:#666; float:right;">by ${i.u}</small></div>`).join('') : ""; 
        }); 
    }
    function uploadPhoto(input) { 
        const f = input.files[0]; 
        if(f) { 
            const r = new FileReader(); 
            r.onload = e => db.ref('gallery_v2').push({ img: e.target.result, u: currentUser }); 
            r.readAsDataURL(f); 
        } 
    }
    function loadGallery() { 
        db.ref('gallery_v2').on('value', s => { 
            const d = s.val(); 
            document.getElementById('g-list').innerHTML = d ? Object.keys(d).reverse().map(k => `<div class="insta-item" style="background-image:url('${d[k].img}')" onclick="if(confirm('ì´ ì‚¬ì§„ì„ ê°¤ëŸ¬ë¦¬ì—ì„œ ì‚­ì œí• ê¹Œìš”?')) db.ref('gallery_v2/${k}').remove()"></div>`).join('') : ""; 
        }); 
    }
</script>
</body>
</html>