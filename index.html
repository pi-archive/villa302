<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Villa 302: Final Archive</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root { --neon-red: #ff3131; --neon-green: #39ff14; --msg-blue: #007aff; --msg-gray: #e9e9eb; --apple-bg: #1c1c1e; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: white; overflow: hidden; font-family: -apple-system, sans-serif; }
        
        /* [1] ì…ì¥ í™”ë©´ & í‚¤íŒ¨ë“œ ë ˆì´ì•„ì›ƒ */
        #entry-page { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: url('villa interior.png') no-repeat center center/cover; z-index: 50000; display: flex; justify-content: center; align-items: center; }
        .lock-box { background: rgba(0,0,0,0.9); backdrop-filter: blur(25px); padding: 40px; border-radius: 35px; border: 1px solid rgba(255,255,255,0.1); width: 340px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .user-sel-btn { flex: 1; padding: 18px; background: rgba(255,255,255,0.05); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 15px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .user-sel-btn.active { border-color: var(--neon-green); color: var(--neon-green); background: rgba(57,255,20,0.1); box-shadow: 0 0 15px rgba(57,255,20,0.2); }
        #pw-disp { font-size: 3rem; color: var(--neon-red); margin-bottom: 30px; height: 60px; letter-spacing: 10px; display: flex; align-items: center; justify-content: center; font-family: monospace; text-shadow: 0 0 10px var(--neon-red); }
        .key-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
        .key { padding: 22px; background: rgba(255,255,255,0.07); border-radius: 15px; cursor: pointer; font-size: 1.3rem; transition: 0.2s; }
        .key:active { background: rgba(255,255,255,0.2); transform: scale(0.95); }

        /* [2] ë©”ì¸ ê±°ì‹¤ ìŠ¤í…Œì´ì§€ */
        #stage { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100vw; height: 66.67vw; max-width: 150vh; max-height: 100vh; background: url('villa.png') no-repeat center center/contain; background-color: #000; }
        .target { position: absolute; cursor: pointer; z-index: 10; border-radius: 15px; transition: 0.3s; }
        .target:hover { background: rgba(255,255,255,0.15); box-shadow: 0 0 20px rgba(255,255,255,0.1); }
        .wall-pos { top: 18%; left: 50%; width: 15%; height: 35%; } 
        .movie-pos { top: 8%; left: 63%; width: 20%; height: 15%; } 
        .cal-pos { top: 45%; left: 74%; width: 8%; height: 20%; } 
        .diary-pos { top: 52%; left: 57%; width: 13%; height: 8%; } 
        .photo-pos { top: 25%; left: 72%; width: 10%; height: 20%; } 
        .lib-pos { top: 35%; left: 35%; width: 12%; height: 25%; } 

        /* [3] ëª¨ë‹¬ ë§ˆìŠ¤í„° ì‹œìŠ¤í…œ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.96); z-index: 10000; justify-content: center; align-items: center; }
        .modal-inner { background: var(--apple-bg); width: 94%; max-width: 850px; height: 88vh; border-radius: 40px; padding: 35px; overflow-y: auto; position: relative; border: 1px solid rgba(255,255,255,0.12); box-shadow: 0 25px 50px rgba(0,0,0,0.8); }
        .close-btn { position: absolute; top: 25px; right: 35px; font-size: 2.8rem; color: #555; cursor: pointer; transition: 0.2s; }
        .close-btn:hover { color: #fff; }

        /* [4] ê° ê¸°ëŠ¥ë³„ ì„¸ë¶€ ë ˆì´ì•„ì›ƒ */
        /* ì˜í™”: ë³„ì  & ëŒ“ê¸€ */
        .mv-card { background: #2c2c2e; padding: 25px; border-radius: 20px; margin-bottom: 25px; position: relative; border-left: 6px solid var(--neon-red); }
        .star-rating { color: #ffd700; font-size: 1.3rem; margin-bottom: 10px; }
        .cm-list { background: rgba(0,0,0,0.25); padding: 12px; border-radius: 12px; margin-top: 15px; }
        .cm-item { font-size: 0.9rem; padding: 6px 0; border-bottom: 1px solid #3d3d3f; color: #ccc; }

        /* ë°©ëª…ë¡: ì „ë‹¨ì§€ ë–¼ê¸° */
        .leaflet-container { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
        .leaflet { background: #fff59d; color: #000; width: 180px; padding: 20px; font-family: 'Nanum Pen Script'; font-size: 1.5rem; position: relative; box-shadow: 5px 5px 15px rgba(0,0,0,0.3); transform: rotate(-1.5deg); transition: 0.3s; }
        .leaflet:nth-child(even) { transform: rotate(2deg); background: #ffecb3; }
        .tear-off { position: absolute; top: 0; right: 8px; cursor: pointer; color: #ff3131; font-weight: bold; font-size: 1.4rem; }

        /* ê°¤ëŸ¬ë¦¬: ì¸ìŠ¤íƒ€ í”¼ë“œ */
        .insta-post { background: #000; border: 1px solid #333; margin-bottom: 40px; border-radius: 10px; overflow: hidden; }
        .insta-header { padding: 15px; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .insta-img { width: 100%; aspect-ratio: 1/1; background-size: cover; background-position: center; border-top: 1px solid #222; border-bottom: 1px solid #222; }
        .insta-body { padding: 15px; }

        /* ì¼ê¸°ì¥: ì•„ì´ë©”ì‹œì§€ */
        .diary-theme { background: #fff !important; color: #000 !important; }
        #diary-chat { height: calc(100% - 160px); overflow-y: auto; padding: 20px; display: flex; flex-direction: column; }
        .diary-row { display: flex; margin-bottom: 15px; align-items: flex-end; width: 100%; }
        .profile-img { width: 40px; height: 40px; border-radius: 50%; background-size: cover; margin: 0 12px; background-color: #eee; flex-shrink: 0; }
        .bubble { max-width: 65%; padding: 14px 18px; border-radius: 22px; font-size: 1rem; line-height: 1.5; }
        .bubble.mine { background: var(--msg-blue); color: #fff; margin-left: auto; border-bottom-right-radius: 5px; }
        .bubble.yours { background: var(--msg-gray); color: #000; border-bottom-left-radius: 5px; }

        /* ì„œì¬: ê³ ë„í™” ë¦¬ìŠ¤íŠ¸ */
        .book-log { background: #3d2b1f; border-left: 12px solid #2a1d15; padding: 20px; border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; }

        /* ìº˜ë¦°ë” */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; background: #ddd; border: 1px solid #ddd; }
        .cal-day { background: white; color: black; min-height: 80px; padding: 8px; cursor: pointer; font-weight: bold; }

        /* UI ê³µí†µ */
        input, textarea, select { width: 100%; padding: 16px; background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.15); color: white; border-radius: 15px; margin-bottom: 12px; box-sizing: border-box; font-size: 1rem; }
        .btn-main { background: var(--msg-blue); color: white; border: none; padding: 16px; border-radius: 15px; width: 100%; cursor: pointer; font-weight: bold; font-size: 1rem; }
        #sitemap-btn { position: fixed; top: 30px; left: 30px; z-index: 1100; cursor: pointer; font-size: 2rem; background: rgba(255,255,255,0.1); width: 60px; height: 60px; border-radius: 18px; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
    </style>
</head>
<body>

<div id="bgm-player" style="position:fixed; top:-3000px;"><div id="player"></div></div>
<div id="sitemap-btn" onclick="openTab('sitemap')">â˜°</div>

<div id="entry-page">
    <div class="lock-box">
        <h2 style="color:white; margin-bottom:25px; letter-spacing: 2px;">VILLA 302</h2>
        <div style="display:flex; gap:12px; margin-bottom:25px;">
            <button onclick="selU('í‰í™”','1231')" id="b-í‰í™”" class="user-sel-btn">í‰í™”</button>
            <button onclick="selU('ì¸ì² ','0526')" id="b-ì¸ì² " class="user-sel-btn">ì¸ì² </button>
        </div>
        <div id="pw-disp">----</div>
        <div class="key-grid">
            <script>for(let i=1; i<=9; i++) document.write(`<div class="key" onclick="press('${i}')">${i}</div>`);</script>
            <div class="key" onclick="inputPw=''; updatePw();">C</div>
            <div class="key" onclick="press('0')">0</div>
            <div class="key" style="background:var(--neon-red)" onclick="checkPw()">E</div>
        </div>
    </div>
</div>

<div id="stage">
    <div class="target wall-pos" onclick="openTab('wall')"></div>
    <div class="target movie-pos" onclick="openTab('movie')"></div>
    <div class="target cal-pos" onclick="openTab('calendar')"></div>
    <div class="target diary-pos" onclick="openTab('diary')"></div>
    <div class="target photo-pos" onclick="openTab('gallery')"></div>
    <div class="target lib-pos" onclick="openTab('library')"></div>
</div>

<div id="main-modal" class="modal">
    <div class="modal-inner" id="modal-box">
        <span class="close-btn" onclick="closeModal()">Ã—</span>
        <div id="modal-content"></div>
    </div>
</div>

<script>
    // --- [Firebase ë° ì´ˆê¸°í™”] ---
    const firebaseConfig = {
        apiKey: "AIzaSyDLTGv4Z3zJUseuKw1acvHHwPzooZhXodc",
        databaseURL: "https://villa302-default-rtdb.firebaseio.com",
        projectId: "villa302",
        appId: "1:166700659009:web:18c2872914aab8b4bbf1c0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = "", targetPw = "", inputPw = "", userProfiles = {}, player;

    // --- [ì…ì¥ ë° ë¬¼ë¦¬ í‚¤ë³´ë“œ] ---
    function selU(u,p) { currentUser=u; targetPw=p; inputPw=""; document.querySelectorAll('.user-sel-btn').forEach(b=>b.classList.remove('active')); document.getElementById('b-'+u).classList.add('active'); updatePw(); }
    function press(n) { if(inputPw.length<4) inputPw+=n; updatePw(); }
    function updatePw() { document.getElementById('pw-disp').innerText = "*".repeat(inputPw.length)||"----"; }
    function checkPw() {
        if(inputPw === targetPw) {
            document.getElementById('entry-page').style.display='none';
            document.getElementById('sitemap-btn').style.display='flex';
            db.ref('profiles').on('value', s => { userProfiles = s.val() || {}; });
            initBGM();
        } else { alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜"); inputPw=""; updatePw(); }
    }
    window.addEventListener('keydown', e => {
        if(document.getElementById('entry-page').style.display !== 'none') {
            if(e.key >= '0' && e.key <= '9') press(e.key);
            else if(e.key === 'Backspace') { inputPw = inputPw.slice(0, -1); updatePw(); }
            else if(e.key === 'Enter') checkPw();
        }
    });

    // --- [BGM ë¬´í•œ ì¬ìƒ] ---
    var tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
    document.getElementsByTagName('script')[0].parentNode.insertBefore(tag, null);
    function initBGM() {
        player = new YT.Player('player', { height: '0', width: '0', events: { 'onReady': () => {
            db.ref('bgm_vfinal').on('value', s => {
                const data = s.val(); if(!data) return;
                const ids = Object.values(data).map(i => i.id);
                player.loadPlaylist({ playlist: ids.join(','), listType: 'playlist' });
            });
        }}});
    }

    // --- [íƒ­ ì»¨íŠ¸ë¡¤ & ì‚¬ì´íŠ¸ë§µ] ---
    function openTab(id) {
        const box = document.getElementById('modal-box');
        const content = document.getElementById('modal-content');
        box.className = (id === 'diary' ? 'modal-inner diary-theme' : 'modal-inner');
        document.getElementById('main-modal').style.display = 'flex';
        
        if(id === 'sitemap') {
            content.innerHTML = `<h3>SITEMAP</h3><div class="sm-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px;">
                ${['movie','wall','gallery','library','calendar','diary','bgm','profile'].map(m=>`<div class="btn-main" style="background:#333; text-align:center;" onclick="openTab('${m}')">${m.toUpperCase()}</div>`).join('')}
            </div>`;
        } else if(id === 'movie') {
            content.innerHTML = `<h3>ğŸ¬ MOVIE THEATER</h3><input id="mv-t" placeholder="ì˜í™” ì œëª©"><textarea id="mv-r" placeholder="ì§§ì€ í‰ì„ ë‚¨ê²¨ì£¼ì„¸ìš”"></textarea>
                <select id="mv-s"><option value="5">â­â­â­â­â­</option><option value="4">â­â­â­â­</option><option value="3">â­â­â­</option><option value="2">â­â­</option></select>
                <button class="btn-main" onclick="addMv()">ì•„ì¹´ì´ë¸Œ ì €ì¥</button><div id="mv-list" style="margin-top:30px;"></div>`;
            renderMv();
        } else if(id === 'wall') {
            content.innerHTML = `<h3>ğŸ§± THE WALL</h3><p style="color:gray; font-size:0.8rem;">ì „ë‹¨ì§€ ìš°ì¸¡ ìƒë‹¨ Xë¥¼ ëˆŒëŸ¬ ë—„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                <textarea id="wl-i" placeholder="ë‚¨ê¸°ê³  ì‹¶ì€ ë©”ì‹œì§€..."></textarea><button class="btn-main" onclick="addWl()">ë²½ì— ë¶™ì´ê¸°</button>
                <div class="leaflet-container" id="wl-list" style="margin-top:30px;"></div>`;
            renderWl();
        } else if(id === 'gallery') {
            content.innerHTML = `<h3>ğŸ“¸ GALLERY FEED</h3><input type="file" onchange="addPic(this)"><div id="gal-list" style="margin-top:25px;"></div>`;
            renderPic();
        } else if(id === 'diary') {
            content.innerHTML = `<div id="diary-chat"></div><div style="display:flex; gap:10px; padding:15px; background:#fff; border-top:1px solid #eee;">
                <textarea id="dy-in" placeholder="iMessage" style="color:black; background:#f0f0f0; margin:0; height:50px; resize:none;"></textarea>
                <button class="btn-main" style="width:60px; height:50px; margin:0;" onclick="addDy()">â†‘</button></div>`;
            renderDy();
        } else if(id === 'library') {
            content.innerHTML = `<h3>ğŸ“š VILLA LIBRARY</h3><input id="bk-t" placeholder="ë„ì„œ ì œëª©"><input id="bk-d" type="date">
                <select id="bk-st"><option>ì½ëŠ” ì¤‘</option><option>ì™„ë…</option><option>ì†Œì¥ì¤‘</option><option>ì„ ë¬¼ë°›ìŒ</option></select>
                <button class="btn-main" onclick="addBk()">ì„œì¬ ë“±ë¡</button><div id="bk-list" style="margin-top:30px;"></div>`;
            renderBk();
        } else if(id === 'calendar') {
            content.innerHTML = `<h3>ğŸ“… 302 CALENDAR</h3><div id="cal-area"></div><div id="cal-edit" style="display:none; background:#f9f9f9; padding:20px; border-radius:20px; margin-top:20px; color:black;">
                <p>ì˜¤ëŠ˜ì˜ ê¸°ë¡:</p><div style="display:flex; gap:15px; font-size:2rem;">${['ğŸ ','ğŸ¬','ğŸº','ğŸ˜­','â¤ï¸','â­'].map(e=>`<span style="cursor:pointer;" onclick="saveCal('${e}')">${e}</span>`).join('')}</div></div>`;
            renderCal();
        } else if(id === 'bgm') {
            content.innerHTML = `<h3>ğŸµ BGM MANAGER</h3><input id="bgm-in" placeholder="ìœ íŠœë¸Œ ë§í¬ ë˜ëŠ” ID"><button class="btn-main" onclick="addBgm()">í”Œë ˆì´ë¦¬ìŠ¤íŠ¸ ì¶”ê°€</button><div id="bgm-list" style="margin-top:20px;"></div>`;
            renderBgm();
        } else if(id === 'profile') {
            content.innerHTML = `<h3>ğŸ‘¤ PROFILE SETTING</h3><div id="pf-pre" style="width:120px; height:120px; border-radius:50%; margin:0 auto 20px; background-size:cover; border:3px solid var(--neon-green); background-image:url('${userProfiles[currentUser]||''}')"></div>
                <input type="file" onchange="prePf(this)"><button class="btn-main" onclick="savePf()">í”„ë¡œí•„ ì‚¬ì§„ ì €ì¥</button>`;
        }
    }

    // --- [Logic: Movie (ë³„ì /ëŒ“ê¸€/ì‚­ì œ)] ---
    function addMv() { const t=document.getElementById('mv-t').value, r=document.getElementById('mv-r').value, s=document.getElementById('mv-s').value; if(t) db.ref('movie_vfinal').push({t, r, s, u:currentUser, ts:Date.now()}); }
    function renderMv() {
        db.ref('movie_vfinal').on('value', s => {
            const d = s.val(); const div = document.getElementById('mv-list'); if(!div || !d) return;
            div.innerHTML = Object.keys(d).reverse().map(k => `
                <div class="mv-card">
                    <b>${d[k].t}</b> <div class="star-rating">${'â˜…'.repeat(d[k].s)}</div>
                    <p style="font-size:0.95rem; line-height:1.6; color:#ddd;">${d[k].r}</p>
                    <small style="color:gray;">Writer: ${d[k].u}</small>
                    <div class="cm-list" id="mcm-${k}"></div>
                    <div style="display:flex; gap:8px; margin-top:10px;"><input id="mcmin-${k}" placeholder="ëŒ“ê¸€ ë‹¬ê¸°..." style="margin:0; padding:10px; font-size:0.8rem;"><button class="btn-main" style="width:50px; padding:10px; margin:0;" onclick="addMvCm('${k}')">âœï¸</button></div>
                    ${d[k].u===currentUser?`<button style="position:absolute; top:20px; right:20px; background:none; border:none; color:#ff4444; cursor:pointer;" onclick="if(confirm('ì‚­ì œ?'))db.ref('movie_vfinal/${k}').remove()">ì‚­ì œ</button>`:''}
                </div>`).join('');
            Object.keys(d).forEach(k => renderMvCm(k));
        });
    }
    function addMvCm(k) { const v=document.getElementById('mcmin-'+k).value; if(v) db.ref(`movie_vfinal/${k}/cms`).push({v, u:currentUser}); document.getElementById('mcmin-'+k).value=""; }
    function renderMvCm(k) {
        db.ref(`movie_vfinal/${k}/cms`).on('value', s => {
            const d=s.val(); const div=document.getElementById('mcm-'+k); if(div && d) div.innerHTML = Object.values(d).map(c=>`<div class="cm-item"><b>${c.u}:</b> ${c.v}</div>`).join('');
        });
    }

    // --- [Logic: Wall (ì „ë‹¨ì§€ ë–¼ê¸°)] ---
    function addWl() { const t=document.getElementById('wl-i').value; if(t) db.ref('wall_vfinal').push({t, u:currentUser}); document.getElementById('wl-i').value=""; }
    function renderWl() {
        db.ref('wall_vfinal').on('value', s => {
            const d = s.val(); const div = document.getElementById('wl-list'); if(!div || !d) { div.innerHTML=""; return; }
            div.innerHTML = Object.keys(d).map(k => `
                <div class="leaflet">
                    <div class="tear-off" onclick="if(confirm('ì´ ì „ë‹¨ì§€ë¥¼ ë–¼ì–´ë‚¼ê¹Œìš”?')) db.ref('wall_vfinal/${k}').remove()">Ã—</div>
                    ${d[k].t}<br><small style="font-size:0.8rem; opacity:0.6; display:block; margin-top:10px;">- From. ${d[k].u}</small>
                </div>`).join('');
        });
    }

    // --- [Logic: Gallery (ì¸ìŠ¤íƒ€ í”¼ë“œ)] ---
    function addPic(i) { if(i.files[0]) { const r=new FileReader(); r.onload=e=>db.ref('gal_vfinal').push({img:e.target.result, u:currentUser, ts:Date.now()}); r.readAsDataURL(i.files[0]); } }
    function renderPic() {
        db.ref('gal_vfinal').on('value', s => {
            const d = s.val(); const div = document.getElementById('gal-list'); if(!div || !d) return;
            div.innerHTML = Object.keys(d).reverse().map(k => `
                <div class="insta-post">
                    <div class="insta-header"><div style="width:30px; height:30px; border-radius:50%; background-image:url('${userProfiles[d[k].u]||''}'); background-size:cover;"></div>${d[k].u}</div>
                    <div class="insta-img" style="background-image:url('${d[k].img}')"></div>
                    <div class="insta-body">
                        <div id="gcm-${k}" style="margin-bottom:10px; font-size:0.9rem;"></div>
                        <div style="display:flex; gap:8px;"><input id="gcmin-${k}" placeholder="ëŒ“ê¸€..." style="margin:0; padding:10px; font-size:0.8rem;"><button class="btn-main" style="width:50px; padding:10px; margin:0;" onclick="addGalCm('${k}')">â¤ï¸</button></div>
                    </div>
                    ${d[k].u===currentUser?`<button onclick="db.ref('gal_vfinal/${k}').remove()" style="padding:10px; background:none; border:none; color:gray; font-size:0.7rem;">í¬ìŠ¤íŠ¸ ì‚­ì œ</button>`:''}
                </div>`).join('');
            Object.keys(d).forEach(k => renderGalCm(k));
        });
    }
    function addGalCm(k) { const v=document.getElementById('gcmin-'+k).value; if(v) db.ref(`gal_vfinal/${k}/cms`).push({v, u:currentUser}); document.getElementById('gcmin-'+k).value=""; }
    function renderGalCm(k) {
        db.ref(`gal_vfinal/${k}/cms`).on('value', s => {
            const d=s.val(); const div=document.getElementById('gcm-'+k); if(div && d) div.innerHTML = Object.values(d).map(c=>`<div><b>${c.u}</b> ${c.v}</div>`).join('');
        });
    }

    // --- [Logic: Diary (ì•„ì´ë©”ì‹œì§€)] ---
    function addDy() { const t=document.getElementById('dy-in').value; if(t.trim()) db.ref('diary_vfinal').push({t, u:currentUser, ts:Date.now()}); document.getElementById('dy-in').value=""; }
    function renderDy() {
        db.ref('diary_vfinal').on('value', s => {
            const d = s.val(); const div = document.getElementById('diary-chat'); if(!div || !d) return;
            div.innerHTML = Object.keys(d).map(k => {
                const isMine = d[k].u === currentUser;
                return `<div class="diary-row" style="flex-direction:${isMine?'row-reverse':'row'}">
                    <div class="profile-img" style="background-image:url('${userProfiles[d[k].u]||''}')"></div>
                    <div class="bubble ${isMine?'mine':'yours'}" onclick="${isMine?`if(confirm('ì‚­ì œ?'))db.ref('diary_vfinal/${k}').remove()` : ''}">${d[k].t}</div>
                </div>`;
            }).join('');
            div.scrollTop = div.scrollHeight;
        });
    }

    // --- [Logic: Library (ê³ ë„í™”)] ---
    function addBk() { const t=document.getElementById('bk-t').value, d=document.getElementById('bk-d').value, st=document.getElementById('bk-st').value; if(t) db.ref('lib_vfinal').push({t, d, st, u:currentUser}); }
    function renderBk() {
        db.ref('lib_vfinal').on('value', s => {
            const d = s.val(); const div = document.getElementById('bk-list'); if(!div || !d) { div.innerHTML=""; return; }
            div.innerHTML = Object.keys(d).reverse().map(k => `
                <div class="book-log">
                    <div><b style="font-size:1.1rem;">ğŸ“– ${d[k].t}</b><br><small style="color:#aaa;">${d[k].st} | ${d[k].d}</small></div>
                    <button style="background:none; border:none; color:#888; cursor:pointer;" onclick="db.ref('lib_vfinal/${k}').remove()">ì‚­ì œ</button>
                </div>`).join('');
        });
    }

    // --- [Logic: Calendar] ---
    let selDay = "";
    function renderCal() {
        db.ref('cal_vfinal').on('value', s => {
            const data = s.val() || {}; let html = `<div class="cal-grid">`;
            for(let i=1; i<=31; i++) {
                const k = `2024-10-${i}`;
                html += `<div class="cal-day" onclick="selDay='${k}'; document.getElementById('cal-edit').style.display='block'">${i}<div style="font-size:1.8rem; text-align:center;">${data[k]||''}</div></div>`;
            }
            document.getElementById('cal-area').innerHTML = html + `</div>`;
        });
    }
    function saveCal(e) { if(selDay) db.ref('cal_vfinal/'+selDay).set(e); }

    // --- [Logic: BGM] ---
    function addBgm() { const v=document.getElementById('bgm-in').value; const id=v.includes('v=')?v.split('v=')[1].split('&')[0]:v; if(id) db.ref('bgm_vfinal').push({id}); }
    function renderBgm() {
        db.ref('bgm_vfinal').on('value', s => {
            const d=s.val(); const div=document.getElementById('bgm-list'); if(div && d) div.innerHTML = Object.keys(d).map(k=>`<div style="padding:10px; border-bottom:1px solid #333;">ğŸµ ${d[k].id} <span style="float:right; color:red; cursor:pointer;" onclick="db.ref('bgm_vfinal/${k}').remove()">ì‚­ì œ</span></div>`).join('');
        });
    }

    // --- [Logic: Profile] ---
    let tmpPf = "";
    function prePf(i) { if(i.files[0]){ const r=new FileReader(); r.onload=e=>{ document.getElementById('pf-pre').style.backgroundImage=`url('${e.target.result}')`; tmpPf=e.target.result; }; r.readAsDataURL(i.files[0]); } }
    function savePf() { if(tmpPf) db.ref('profiles/'+currentUser).set(tmpPf).then(()=>alert("í”„ë¡œí•„ ì €ì¥ ì™„ë£Œ!")); }

    function closeModal() { document.getElementById('main-modal').style.display = 'none'; }
</script>
</body>
</html>