<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Villa 302: The Ultimate Archive</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&family=Noto+Sans+KR:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --neon-red: #ff3131; --neon-green: #39ff14; --msg-blue: #007aff; 
            --msg-gray: #e9e9eb; --gold: #ffd700; --bg: #050505;
        }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: white; overflow: hidden; font-family: 'Noto Sans KR', sans-serif; }

        /* ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ */
        #top-nav { position: fixed; top: 0; left: 0; right: 0; padding: 25px 40px; display: flex; justify-content: space-between; align-items: center; z-index: 5000; }
        .sitemap { background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); padding: 12px 25px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); font-size: 0.8rem; letter-spacing: 2px; color: #aaa; cursor: pointer; }
        .sitemap span { transition: 0.3s; }
        .sitemap span:hover { color: var(--neon-green); text-shadow: 0 0 10px var(--neon-green); }
        .user-ctrl { display: flex; align-items: center; gap: 15px; background: rgba(0,0,0,0.6); padding: 8px 20px; border-radius: 50px; border: 1px solid var(--neon-green); cursor: pointer; visibility: hidden; }
        .user-ctrl img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 1px solid var(--neon-green); }

/* BGM ì»¨íŠ¸ë¡¤ëŸ¬ ì™¼ìª½ í•˜ë‹¨ ê³ ì • ìŠ¤íƒ€ì¼ */
#bgm-container { 
    position: fixed;
    bottom: 30px;
    left: 30px;
    width: 280px; 
    background: rgba(15, 15, 15, 0.9);
    border: 1px solid #333;
    border-radius: 20px;
    padding: 12px 18px;
    display: flex;
    align-items: center;
    z-index: 9000;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.player-info { flex: 1; overflow: hidden; margin-left: 10px; }
#now-playing { 
    font-size: 0.7rem; 
    white-space: nowrap; 
    color: var(--neon-green); 
    font-family: monospace;
    animation: marquee 10s linear infinite;
}

@keyframes marquee {
    0% { transform: translateX(100%); }
    100% { transform: translateX(-100%); }
}

.player-controls { display: flex; align-items: center; gap: 10px; margin-top: 5px; }
.p-btn { cursor: pointer; font-size: 0.9rem; opacity: 0.7; transition: 0.2s; color: #fff; }
.p-btn:hover { opacity: 1; color: var(--neon-green); }
#vol-control { width: 50px; height: 3px; accent-color: var(--neon-green); cursor: pointer; }

/* ì„¸íŒ… ë²„íŠ¼ ë° íŒ¨ë„ */
.playlist-trigger { 
    font-size: 1.1rem; cursor: pointer; margin-left: 12px; opacity: 0.6; transition: 0.3s;
}
.playlist-trigger:hover { opacity: 1; transform: rotate(45deg); }

#playlist-panel {
    position: absolute; 
    bottom: 80px; 
    left: 0; 
    width: 280px; 
    background: rgba(10, 10, 10, 0.98); 
    border: 1px solid #444;
    border-radius: 20px; 
    padding: 15px; 
    display: none; /* ì´ˆê¸° ìˆ¨ê¹€ */
    box-shadow: 0 10px 40px rgba(0,0,0,0.8);
}

.url-input-group { display: flex; gap: 5px; margin-bottom: 12px; }
#yt-url-input { 
    flex: 1; background: #222; border: 1px solid #444; color: #fff; 
    font-size: 0.75rem; padding: 8px; border-radius: 8px; outline: none;
}
.mini-btn { 
    background: var(--neon-green); border: none; border-radius: 8px; 
    cursor: pointer; padding: 0 12px; font-weight: bold; color: #000;
}

#playlist-items { max-height: 180px; overflow-y: auto; }
.playlist-item { 
    font-size: 0.75rem; padding: 8px; border-bottom: 1px solid #222;
    cursor: pointer; display: flex; justify-content: space-between; align-items: center;
}
.playlist-item:hover { background: rgba(57, 255, 20, 0.1); }
.playlist-item small { color: var(--neon-red); cursor: pointer; margin-left: 10px; font-weight: bold; }

        /* ì…ì¥ ë„ì–´ë½ */
        #entry-page { position: fixed; inset: 0; background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url('villa interior.png') no-repeat center center/cover; z-index: 999999; display: flex; justify-content: center; align-items: center; }
        .lock-box { background: rgba(17,17,17,0.9); padding: 50px; border-radius: 60px; border: 2px solid #333; width: 380px; text-align: center; box-shadow: 0 0 80px rgba(0,0,0,1); backdrop-filter: blur(15px); }
        .profile-group { display: flex; gap: 20px; margin-bottom: 40px; justify-content: center; }
        .u-profile { cursor: pointer; transition: 0.4s; position: relative; opacity: 0.4; filter: grayscale(100%); }
        .u-profile.active { opacity: 1; filter: grayscale(0%); transform: scale(1.1); }
        .u-profile img { width: 90px; height: 90px; border-radius: 50%; border: 4px solid transparent; object-fit: cover; }
        .u-profile.active img { border-color: var(--neon-green); box-shadow: 0 0 25px rgba(57,255,20,0.5); }
        .u-profile p { margin-top: 12px; font-weight: bold; color: #888; }
        .u-profile.active p { color: var(--neon-green); }
        #pw-display { font-size: 3.5rem; color: var(--neon-red); margin: 30px 0; height: 75px; letter-spacing: 18px; text-shadow: 0 0 20px var(--neon-red); font-family: 'monospace'; }
        .key-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .k-btn { padding: 25px; background: #1a1a1a; border-radius: 20px; cursor: pointer; font-size: 1.6rem; border: 1px solid #222; transition: 0.1s; color: #fff; }
        .k-btn:active { background: #333; transform: scale(0.95); }

        /* ìŠ¤í…Œì´ì§€ */
        #stage { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100vw; height: 66.67vw; max-width: 150vh; max-height: 100vh; background: url('villa.png') no-repeat center center/contain; }
        .hotspot { position: absolute; cursor: pointer; z-index: 110; border-radius: 15px; transition: 0.3s; }
        .hotspot:hover { background: rgba(255,255,255,0.1); box-shadow: 0 0 30px rgba(255,255,255,0.2); }
        .z-wall { top: 18%; left: 48%; width: 18%; height: 35%; } 
        .z-movie { top: 8%; left: 63%; width: 20%; height: 15%; } 
        .z-cal { top: 45%; left: 74%; width: 8%; height: 20%; } 
        .z-diary { top: 52%; left: 57%; width: 13%; height: 8%; } 
        .z-gallery { top: 25%; left: 72%; width: 10%; height: 20%; } 
        .z-lib { top: 35%; left: 35%; width: 12%; height: 25%; } 
        .z-exit { top: 40%; left: 85%; width: 10%; height: 40%; } 

        /* ëª¨ë‹¬ ê³µí†µ */
        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.94); z-index: 10000; justify-content: center; align-items: center; backdrop-filter: blur(20px); transition: 0.3s; }
        .modal-window { background: #fff; color: #000; width: 95%; max-width: 850px; border-radius: 45px; padding: 45px; position: relative; max-height: 85vh; overflow-y: auto; box-shadow: 0 30px 60px rgba(0,0,0,0.5); animation: modalUp 0.4s cubic-bezier(0.17, 0.67, 0.83, 0.67); }
        @keyframes modalUp { from { transform: translateY(50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* iMessage ë‹¤ì´ì–´ë¦¬ ë¯¸ë””ì–´ ëŒ€ì‘ */
        .imsg-wrap { display: flex; flex-direction: column; height: 480px; overflow-y: auto; padding: 30px; background: #f2f2f7; border-radius: 40px; }
        .imsg-bubble img { max-width: 100%; border-radius: 15px; margin-top: 10px; cursor: zoom-in; }
        .imsg-input-area { display: flex; gap: 10px; margin-top: 20px; align-items: center; }

        /* ê¸°íƒ€ ìŠ¤íƒ€ì¼ ìƒëµ ì—†ì´ ê¸°ì¡´ ìœ ì§€ */
        .cal-wrapper { display: grid; grid-template-columns: repeat(7, 1fr); gap: 12px; margin-top: 25px; }
        .cal-cell { border: 1px solid #eee; min-height: 130px; padding: 15px; border-radius: 25px; cursor: pointer; transition: 0.3s; background: #fff; }
        .cal-cell:hover { transform: translateY(-8px); box-shadow: 0 15px 30px rgba(0,0,0,0.08); }
        .cell-num { font-size: 1.2rem; font-weight: 800; color: #333; }
        .cell-emoji { font-size: 2.5rem; display: block; text-align: center; margin: 10px 0; }
        .cell-brief { font-size: 0.8rem; color: #888; text-align: center; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .lib-shelf { background: #4e342e; padding: 30px; border-radius: 12px; border-bottom: 25px solid #261613; display: flex; align-items: flex-end; height: 180px; gap: 12px; overflow-x: auto; }
        .book-obj { min-width: 48px; height: 150px; border-radius: 6px 6px 2px 2px; writing-mode: vertical-rl; text-align: center; color: white; font-weight: bold; cursor: pointer; font-size: 1.1rem; border-left: 4px solid rgba(255,255,255,0.2); transition: 0.3s; }
        .book-obj:hover { height: 175px; filter: brightness(1.2); transform: translateY(-5px); }
        #wall-board { position: relative; width: 100%; height: 550px; background: #cbbba0; border-radius: 30px; overflow: hidden; border: 15px solid #8d6e63; box-shadow: inset 0 0 50px rgba(0,0,0,0.3); }
        .flyer { position: absolute; padding: 20px; font-family: 'Nanum Pen Script'; font-size: 1.8rem; box-shadow: 8px 12px 20px rgba(0,0,0,0.25); cursor: pointer; transition: 0.2s; max-width: 200px; word-break: break-all; }
        .movie-card { background: #f9f9fb; border-radius: 35px; padding: 35px; margin-bottom: 30px; border: 1px solid #f0f0f0; }
        .photo-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 30px; margin-top: 30px; }
        .polaroid-frame { background: #fff; padding: 18px 18px 50px 18px; box-shadow: 0 15px 35px rgba(0,0,0,0.2); transform: rotate(-2deg); transition: 0.3s; }
        .polaroid-frame:nth-child(even) { transform: rotate(2deg); }
        .polaroid-frame:hover { transform: rotate(0deg) scale(1.05); z-index: 10; }
        .btn-action { background: #000; color: #fff; border: none; padding: 20px 35px; border-radius: 25px; cursor: pointer; font-weight: 800; transition: 0.2s; }
        .btn-action:hover { background: #333; transform: scale(1.02); }
        input, textarea, select { width: 100%; padding: 20px; border: 2px solid #f0f0f0; border-radius: 25px; font-family: inherit; margin-top: 15px; box-sizing: border-box; background: #fafafa; outline: none; }
        .close-btn { position: absolute; top: 35px; right: 45px; font-size: 3.5rem; color: #ddd; cursor: pointer; line-height: 1; }
        #yt-player-container { position: absolute; width: 1px; height: 1px; opacity: 0; pointer-events: none; }
        .imsg-row.me { flex-direction: row-reverse; }
        .imsg-row { display: flex; gap: 12px; margin-bottom: 25px; align-items: flex-end; }
        .imsg-avatar { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; }
        .imsg-bubble { padding: 14px 22px; border-radius: 25px; font-size: 1.05rem; line-height: 1.5; position: relative; }
        .me .imsg-bubble { background: var(--msg-blue); color: #fff; border-bottom-right-radius: 5px; }
        .you .imsg-bubble { background: #fff; color: #000; border-bottom-left-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .imsg-meta { font-size: 0.75rem; color: #999; margin-top: 6px; display: flex; gap: 8px; font-weight: bold; }
        .imsg-comments { width: 100%; margin-top: 8px; background: rgba(0,0,0,0.03); border-radius: 15px; padding: 10px; font-size: 0.85rem; color: #555; }
    </style>
</head>
<body onkeydown="handleGlobalKey(event)">

<div id="top-nav">
    <div class="sitemap">
        <span onclick="openArchive('wall')">WALL</span> Â· 
        <span onclick="openArchive('movie')">MOVIE</span> Â· 
        <span onclick="openArchive('calendar')">CALENDAR</span> Â· 
        <span onclick="openArchive('diary')">DIARY</span> Â· 
        <span onclick="openArchive('gallery')">GALLERY</span> Â· 
        <span onclick="openArchive('library')">LIBRARY</span>
    </div>
    <div class="user-ctrl" id="user-display" onclick="changeProfileImg()">
        <span id="user-name-label" style="font-weight:700; font-size:0.9rem;"></span>
        <img id="user-avatar-img" src="">
    </div>
</div>

<div id="bgm-container">
    <div class="player-info">
        <div id="now-playing">STATION ASLEEP...</div>
        <div class="player-controls">
            <span class="p-btn" onclick="prevTrack()">â®</span>
            <span class="p-btn" id="play-pause-btn" onclick="toggleMusic()">â–¶</span>
            <span class="p-btn" onclick="nextTrack()">â­</span>
            <input type="range" id="vol-control" min="0" max="100" value="50">
        </div>
    </div>
    <div class="playlist-trigger" onclick="togglePlaylist()">âš™ï¸</div>
    <div id="playlist-panel">
        <div class="url-input-group">
            <input type="text" id="yt-url-input" placeholder="YouTube URL ì…ë ¥...">
            <button onclick="addPlaylist()" class="mini-btn">+</button>
        </div>
        <div id="playlist-items"></div>
    </div>
</div>

<div id="yt-player-container" style="display:none;"></div>

<div id="entry-page">
    <div class="lock-box">
        <h1 style="color:white; margin-bottom:45px; font-weight:300; letter-spacing:8px;">VILLA 302</h1>
        <div class="profile-group">
            <div class="u-profile" id="p-peace" onclick="initUser('í‰í™”','1231','peace.jpg')">
                <img src="peace.jpg" alt="P">
                <p>í‰í™”</p>
            </div>
            <div class="u-profile" id="p-in" onclick="initUser('ì¸ì² ','0526','incheol.jpg')">
                <img src="incheol.jpg" alt="I">
                <p>ì¸ì² </p>
            </div>
        </div>
        <div id="pw-display">----</div>
        <div class="key-grid">
            <script>for(let i=1; i<=9; i++) document.write(`<div class="k-btn" onclick="addPw('${i}')">${i}</div>`);</script>
            <div class="k-btn" onclick="clearPw()">C</div>
            <div class="k-btn" onclick="addPw('0')">0</div>
            <div class="k-btn" style="background:var(--neon-red); border:none;" onclick="tryLogin()">E</div>
        </div>
    </div>
</div>

<div id="stage">
    <div class="hotspot z-wall" onclick="openArchive('wall')"></div>
    <div class="hotspot z-movie" onclick="openArchive('movie')"></div>
    <div class="hotspot z-cal" onclick="openArchive('calendar')"></div>
    <div class="hotspot z-diary" onclick="openArchive('diary')"></div>
    <div class="hotspot z-gallery" onclick="openArchive('gallery')"></div>
    <div class="hotspot z-lib" onclick="openArchive('library')"></div>
    <div class="hotspot z-exit" onclick="tryExit()"></div>
</div>

<div id="modal-overlay" class="modal-overlay" onclick="if(event.target === this) closeArchive()">
    <div class="modal-window">
        <span class="close-btn" onclick="closeArchive()">Ã—</span>
        <div id="modal-body"></div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>


<script>
    // 1. Firebase ì„¤ì • ë° ì´ˆê¸°í™”
    const firebaseConfig = {
        apiKey: "AIzaSyDLTGv4Z3zJUseuKw1acvHHwPzooZhXodc",
        authDomain: "villa302.firebaseapp.com",
        databaseURL: "https://villa302-default-rtdb.firebaseio.com",
        projectId: "villa302",
        storageBucket: "villa302.firebasestorage.app",
        messagingSenderId: "166700659009",
        appId: "1:166700659009:web:18c2872914aab8b4bbf1c0",
        measurementId: "G-81FF5SDS0D"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = { name: "", pw: "", img: "" };
    let pwInputString = "";
    // ì´ˆê¸°ê°’ì— ë¹ˆ ê°ì²´/ë°°ì—´ ì„¤ì •í•˜ì—¬ undefined ì˜¤ë¥˜ ë°©ì§€
    let ARCHIVE_DB = { calendar: {}, movies: [], diary: [], books: [], wall: [], gallery: [], profiles: {} };

    // [1] Firebase ì‹¤ì‹œê°„ ë°ì´í„° ì—°ë™
    db.ref('VILLA_302_DATA').on('value', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            // ë°ì´í„°ê°€ ë¡œë“œë  ë•Œ ê¸°ì¡´ êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ë©° ë³‘í•©
            ARCHIVE_DB = {
                calendar: data.calendar || {},
                movies: data.movies || [],
                diary: data.diary || [],
                books: data.books || [],
                wall: data.wall || [],
                gallery: data.gallery || [],
                profiles: data.profiles || {}
            };
            
            if (currentUser.name && ARCHIVE_DB.profiles[currentUser.name]) {
                currentUser.img = ARCHIVE_DB.profiles[currentUser.name];
                const navImg = document.getElementById('user-avatar-img');
                if(navImg) navImg.src = currentUser.img;
            }

            // ëª¨ë‹¬ì´ ì—´ë ¤ìˆì„ ë•Œ ì‹¤ì‹œê°„ ë°ì´í„° ë°˜ì˜ (ìº˜ë¦°ë” í¬í•¨)
            const overlay = document.getElementById('modal-overlay');
            if(overlay && overlay.style.display === 'flex') {
                if(document.getElementById('cal-render')) renderCal();
                if(document.getElementById('dy-render')) renderDiary();
                if(document.getElementById('mv-render')) renderMovies();
            }
        }
    });

    // [2] ì‚¬ìš©ì ì´ˆê¸° ì„ íƒ
    function initUser(n, p, i) {
        let savedImg = i;
        if (ARCHIVE_DB.profiles && ARCHIVE_DB.profiles[n]) {
            savedImg = ARCHIVE_DB.profiles[n];
        } 
        currentUser = { name: n, pw: p, img: savedImg };
        document.querySelectorAll('.u-profile').forEach(el => el.classList.remove('active'));
        const targetId = (n === 'í‰í™”' ? 'p-peace' : 'p-in');
        const targetEl = document.getElementById(targetId);
        if(targetEl) targetEl.classList.add('active');
        pwInputString = ""; 
        updatePwUI();
    }

    // [3] ë¹„ë°€ë²ˆí˜¸ ë° ë¡œê·¸ì¸
    function addPw(n) { 
        if(!currentUser.name) { alert("ì‚¬ìš©ìë¥¼ ë¨¼ì € ì„ íƒí•´ ì£¼ì„¸ìš”."); return; }
        if(pwInputString.length < 4) { pwInputString += n; updatePwUI(); }
        if(pwInputString.length === 4) { tryLogin(); }
    }

    function tryLogin() {
        if(!currentUser.name || pwInputString.length < 4) return;
        if(pwInputString === currentUser.pw) {
            document.getElementById('entry-page').style.display = 'none';
            document.getElementById('user-display').style.visibility = 'visible';
            document.getElementById('user-name-label').innerText = currentUser.name;
            document.getElementById('user-avatar-img').src = currentUser.img;
            playTrack(0);
        } else { 
            alert("ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.");
            clearPw();
        }
    }

    function clearPw() { pwInputString = ""; updatePwUI(); }
    function updatePwUI() { 
        const display = document.getElementById('pw-display');
        if(display) display.innerText = "*".repeat(pwInputString.length).padEnd(4, "-"); 
    }

    function handleGlobalKey(e) {
        const entryPage = document.getElementById('entry-page');
        if (entryPage && entryPage.style.display !== 'none') {
            if (e.key >= '0' && e.key <= '9') addPw(e.key);
            else if (e.key === 'Backspace' || e.key === 'Escape') clearPw();
            else if (e.key === 'Enter' && pwInputString.length === 4) tryLogin();
        }
        if (e.key === "Escape") closeArchive();
    }

    function changeProfileImg() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = e => {
            const file = e.target.files[0];
            if (!file || file.size > 1024 * 1024) { alert("1MB ì´í•˜ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤."); return; }
            const reader = new FileReader();
            reader.onload = ev => {
                const imageData = ev.target.result;
                currentUser.img = imageData;
                document.getElementById('user-avatar-img').src = imageData;
                ARCHIVE_DB.profiles[currentUser.name] = imageData;
                saveToLocal();
            };
            reader.readAsDataURL(file);
        };
        input.click();
    }

    function saveToLocal() {
        db.ref('VILLA_302_DATA').set(ARCHIVE_DB);
    }

    function tryExit() { if(confirm("í‡´ì‹¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) location.reload(); }

    /* BGM ì‹œìŠ¤í…œ */
    let playlist = JSON.parse(localStorage.getItem('villa_playlist')) || [
        { title: "Villa Default Mood", url: "https://www.youtube.com/watch?v=dQw4w9WgXcQ" }
    ];
    let currentTrackIdx = 0;
    let isPlaying = false;

    function togglePlaylist() {
        const panel = document.getElementById('playlist-panel');
        panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
        if (panel.style.display === 'block') renderPlaylist();
    }

    function renderPlaylist() {
        const target = document.getElementById('playlist-items');
        target.innerHTML = playlist.map((track, i) => `
            <div class="playlist-item" onclick="playTrack(${i})">
                <span>${i + 1}. ${track.title}</span>
                <small onclick="event.stopPropagation(); removeTrack(${i})">âœ•</small>
            </div>
        `).join('');
    }

    function addPlaylist() {
        const urlInput = document.getElementById('yt-url-input');
        const url = urlInput.value;
        if (url && (url.includes('youtube.com') || url.includes('youtu.be'))) {
            playlist.push({ title: "USER TRACK " + (playlist.length + 1), url: url });
            urlInput.value = "";
            localStorage.setItem('villa_playlist', JSON.stringify(playlist));
            renderPlaylist();
        }
    }

    function removeTrack(i) {
        if (playlist.length <= 1) return;
        playlist.splice(i, 1);
        localStorage.setItem('villa_playlist', JSON.stringify(playlist));
        renderPlaylist();
    }

    function extractVid(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length == 11) ? match[2] : null;
    }

    function playTrack(idx) {
        currentTrackIdx = idx;
        const track = playlist[idx];
        const vid = extractVid(track.url);
        if (!vid) return;
        document.getElementById('yt-player-container').innerHTML = `<iframe id="yt-iframe" src="https://www.youtube.com/embed/${vid}?autoplay=1&enablejsapi=1" allow="autoplay"></iframe>`;
        document.getElementById('now-playing').innerText = `NOW PLAYING: ${track.title}`;
        document.getElementById('play-pause-btn').innerText = "â¸";
        isPlaying = true;
    }

    function toggleMusic() {
        if (!isPlaying) { playTrack(currentTrackIdx); } 
        else { document.getElementById('yt-player-container').innerHTML = ""; document.getElementById('play-pause-btn').innerText = "â–¶"; isPlaying = false; }
    }

    function nextTrack() { currentTrackIdx = (currentTrackIdx + 1) % playlist.length; playTrack(currentTrackIdx); }
    function prevTrack() { currentTrackIdx = (currentTrackIdx - 1 + playlist.length) % playlist.length; playTrack(currentTrackIdx); }

    /* ì•„ì¹´ì´ë¸Œ í•¨ìˆ˜ */
    function openArchive(type) {
        const body = document.getElementById('modal-body');
        document.getElementById('modal-overlay').style.display = 'flex';
        if(type === 'calendar') {
            body.innerHTML = `<h2>ğŸ“… 2026. 02 ARCHIVE</h2><div class="cal-wrapper" id="cal-render"></div>`;
            renderCal();
        } else if(type === 'movie') {
            body.innerHTML = `<h2>ğŸ¬ MOVIE LOG</h2><div style="background:#f0f0f2; padding:25px; border-radius:30px; margin-bottom:30px;"><input id="mv-tit" placeholder="ì˜í™” ì œëª©"><input id="mv-dir" placeholder="ê°ë…/ê¸°ë¡"><button class="btn-action" style="width:100%; margin-top:15px;" onclick="saveMovie()">ë¦¬ìŠ¤íŠ¸ ì¶”ê°€</button></div><div id="mv-render"></div>`;
            renderMovies();
        } else if(type === 'diary') {
            body.innerHTML = `<h2>ğŸ“” iMessage DIARY</h2><div class="imsg-wrap" id="dy-render"></div><div class="imsg-input-area"><button class="btn-action" onclick="document.getElementById('dy-img-in').click()">ğŸ“·</button><input type="file" id="dy-img-in" style="display:none;" onchange="handleDiaryImage(this)"><input id="dy-in" placeholder="ë©”ì‹œì§€ ì‘ì„±..."><button class="btn-action" onclick="saveDiary()">ì „ì†¡</button></div>`;
            renderDiary();
        } else if(type === 'library') {
            body.innerHTML = `<h2>ğŸ“š PRIVATE LIBRARY</h2><div class="lib-shelf" id="lib-render"></div><div style="margin-top:40px;"><input id="bk-tit" placeholder="ë„ì„œëª…"><textarea id="bk-rev" placeholder="ì§§ì€ ê°ìƒí‰..."></textarea>ì±…ë“± ìƒ‰ìƒ: <input type="color" id="bk-col" value="#5d4037" style="height:60px; padding:5px;"><button class="btn-action" style="width:100%; margin-top:20px;" onclick="saveBook()">ì„œì¬ì— ê½‚ê¸°</button></div>`;
            renderBooks();
        } else if(type === 'wall') {
            body.innerHTML = `<h2>ğŸ§± THE WALL</h2><div id="wall-board"></div><div style="display:flex; gap:12px; margin-top:25px;"><input id="wl-in" placeholder="ë©”ëª¨ ë‚´ìš©" style="margin:0;"><button class="btn-action" onclick="saveFlyer()">ë¶€ì°©</button></div>`;
            renderWall();
        } else if(type === 'gallery') {
            body.innerHTML = `<h2>ğŸ“¸ GALLERY</h2><div style="text-align:right;"><input type="file" id="photo-up" onchange="savePhoto(this)" style="display:none;"><button class="btn-action" onclick="document.getElementById('photo-up').click()">ì‚¬ì§„ ì—…ë¡œë“œ</button></div><div class="photo-grid" id="gal-render"></div>`;
            renderGallery();
        }
    }
    function closeArchive() { document.getElementById('modal-overlay').style.display = 'none'; }

    // ìº˜ë¦°ë” í•µì‹¬ ìˆ˜ì •: ë°ì´í„° ìˆ˜ì‹  ì „/í›„ ëª¨ë‘ ëŒ€ì‘í•˜ë„ë¡ ë¡œì§ ë³´ê°•
    function renderCal() {
        const target = document.getElementById('cal-render'); 
        if(!target) return;
        target.innerHTML = "";
        for(let i=1; i<=28; i++) {
            const dStr = `2026-02-${String(i).padStart(2,'0')}`;
            // ARCHIVE_DB.calendarê°€ ì—†ë”ë¼ë„ ì—ëŸ¬ ë‚˜ì§€ ì•Šê²Œ ì²˜ë¦¬
            const item = (ARCHIVE_DB.calendar && ARCHIVE_DB.calendar[dStr]) ? ARCHIVE_DB.calendar[dStr] : null;
            target.innerHTML += `
                <div class="cal-cell" onclick="openDayEditor('${dStr}')">
                    <span class="cell-num">${i}</span>
                    ${item ? `<span class="cell-emoji">${item.emo}</span><span class="cell-brief">${item.tit}</span>` : ''}
                </div>`;
        }
    }

    function openDayEditor(date) {
        const d = (ARCHIVE_DB.calendar && ARCHIVE_DB.calendar[date]) ? ARCHIVE_DB.calendar[date] : {emo:'ğŸ˜Š', tit:'', txt:''};
        document.getElementById('modal-body').innerHTML = `<h2>ğŸ“… ${date} ê¸°ë¡</h2><select id="ed-emo">${['ğŸ˜Š','â¤ï¸','ğŸ°','ğŸ¬','ğŸ·','ğŸ','âœˆï¸','ğŸ˜­','ğŸ’ª','ğŸ '].map(e=>`<option ${d.emo===e?'selected':''}>${e}</option>`).join('')}</select><input id="ed-tit" placeholder="ì œëª©" value="${d.tit}"><textarea id="ed-txt" placeholder="ì¼ê¸°..." style="height:200px;">${d.txt}</textarea><button class="btn-action" onclick="saveDayData('${date}')">ì €ì¥</button>`;
    }

    function saveDayData(date) {
        if(!ARCHIVE_DB.calendar) ARCHIVE_DB.calendar = {};
        ARCHIVE_DB.calendar[date] = { 
            emo: document.getElementById('ed-emo').value, 
            tit: document.getElementById('ed-tit').value, 
            txt: document.getElementById('ed-txt').value 
        };
        saveToLocal(); 
        openArchive('calendar');
    }

    /* ë‚˜ë¨¸ì§€ ë Œë”ë§ í•¨ìˆ˜ë“¤ (ê¸°ì¡´ ìœ ì§€) */
    function renderDiary() {
        const target = document.getElementById('dy-render');
        if(!target) return;
        let diaryHTML = `<div style="text-align:center; width:100%; color:#8e8e93; font-size:0.8rem; margin:20px 0; font-weight:600; clear:both;">2026ë…„ 2ì›” 12ì¼ ëª©ìš”ì¼</div>`;
        diaryHTML += (ARCHIVE_DB.diary || []).map((d, i) => `
            <div class="imsg-row ${d.u === currentUser.name ? 'me' : 'you'}">
                <img src="${d.img || 'default.jpg'}" class="imsg-avatar">
                <div class="imsg-content">
                    <div class="imsg-bubble">${d.txt}${d.media ? `<img src="${d.media}" style="max-width:100%; border-radius:10px; margin-top:10px;">` : ''}</div>
                    <div class="imsg-meta"><span>${d.u}</span><span onclick="replyDiary(${i})" style="cursor:pointer; margin-left:8px;">ë‹µê¸€(${d.replies ? d.replies.length : 0})</span>${d.u === currentUser.name ? `<span onclick="deleteDiary(${i})" style="cursor:pointer; margin-left:8px;">ì‚­ì œ</span>` : ''}</div>
                    <div class="imsg-comments">${d.replies ? d.replies.map(r => `<div><b>${r.u}:</b> ${r.txt}</div>`).join('') : ''}</div>
                </div>
            </div>`).join('');
        target.innerHTML = diaryHTML;
        target.scrollTop = target.scrollHeight;
    }

    function saveDiary() {
        const v = document.getElementById('dy-in').value;
        if(v || tempDiaryImg) { 
            if(!ARCHIVE_DB.diary) ARCHIVE_DB.diary = [];
            ARCHIVE_DB.diary.push({ u: currentUser.name, img: currentUser.img, txt: v, media: tempDiaryImg, replies: [] }); 
            tempDiaryImg = ""; saveToLocal(); renderDiary(); 
        }
        document.getElementById('dy-in').value = "";
    }

    function renderBooks() {
        const target = document.getElementById('lib-render');
        if(!target) return;
        target.innerHTML = (ARCHIVE_DB.books || []).map((b, i) => `<div class="book-obj" style="background:${b.col}" onclick="handleBookClick(${i})">${b.tit}</div>`).join('');
    }

    function saveBook() {
        const t = document.getElementById('bk-tit').value;
        const r = document.getElementById('bk-rev').value;
        const c = document.getElementById('bk-col').value;
        if(t) { 
            if(!ARCHIVE_DB.books) ARCHIVE_DB.books = [];
            ARCHIVE_DB.books.push({tit: t, rev: r, col: c}); 
            saveToLocal(); renderBooks(); 
            document.getElementById('bk-tit').value = ""; document.getElementById('bk-rev').value = "";
        }
    }

    function renderMovies() {
        const target = document.getElementById('mv-render');
        if(!target) return;
        target.innerHTML = (ARCHIVE_DB.movies || []).map((m, i) => `
            <div class="movie-card" style="position:relative;">
                <div style="position:absolute; top:25px; right:35px; display:flex; gap:12px;">
                    <small onclick="editMovie(${i})" style="cursor:pointer; color:var(--msg-blue); font-weight:bold;">ìˆ˜ì •</small>
                    <small onclick="deleteMovie(${i})" style="cursor:pointer; color:var(--neon-red); font-weight:bold;">ì‚­ì œ</small>
                </div>
                <h3>ğŸ¿ ${m.tit}</h3><p style="color:#666;">${m.dir}</p>
                <div class="thread">${(m.cmts || []).map(c => `<div><b>${c.u}:</b> ${c.txt} (â˜…${c.star})</div>`).join('')}</div>
                <div style="display:flex; gap:10px; margin-top:15px;"><input id="cmt-${i}" placeholder="ì½”ë©˜íŠ¸..." style="margin:0;"><button class="btn-action" onclick="addMovieCmt(${i})">ë“±ë¡</button></div>
            </div>`).join('');
    }

    function saveMovie() {
        const t = document.getElementById('mv-tit').value;
        const d = document.getElementById('mv-dir').value;
        if(t) {
            if(!ARCHIVE_DB.movies) ARCHIVE_DB.movies = [];
            ARCHIVE_DB.movies.push({ tit: t, dir: d, cmts: [] });
            saveToLocal(); renderMovies();
            document.getElementById('mv-tit').value = ""; document.getElementById('mv-dir').value = "";
        }
    }

    function editMovie(i) {
        const m = ARCHIVE_DB.movies[i];
        const newTit = prompt("ì˜í™” ì œëª© ìˆ˜ì •:", m.tit); if (newTit === null) return;
        const newDir = prompt("ê°ë…/ê¸°ë¡ ìˆ˜ì •:", m.dir); if (newDir === null) return;
        ARCHIVE_DB.movies[i].tit = newTit; ARCHIVE_DB.movies[i].dir = newDir;
        saveToLocal(); renderMovies();
    }

    function deleteMovie(i) {
        if(confirm("ì˜í™” í‹°ì¼“ì„ ì°¢ì„ê¹Œìš”?")) { ARCHIVE_DB.movies.splice(i, 1); saveToLocal(); renderMovies(); }
    }

    function addMovieCmt(i) {
        const input = document.getElementById(`cmt-${i}`);
        if(!input.value) return;
        const star = prompt("ë³„ì  (1~5):", "5"); if(star === null) return;
        if(!ARCHIVE_DB.movies[i].cmts) ARCHIVE_DB.movies[i].cmts = [];
        ARCHIVE_DB.movies[i].cmts.push({ u: currentUser.name, txt: input.value, star: star });
        input.value = ""; saveToLocal(); renderMovies();
    }

    function renderWall() {
        const board = document.getElementById('wall-board');
        if(!board) return;
        board.innerHTML = (ARCHIVE_DB.wall || []).map((f, i) => `<div class="flyer" style="left:${f.x}%; top:${f.y}%; background:${f.c}; transform:rotate(${f.r}deg);" onclick="deleteFlyer(${i})">${f.t}</div>`).join('');
    }
    function saveFlyer() {
        const v = document.getElementById('wl-in').value;
        if(v) {
            const colors = ['#fff9c4','#ffccbc','#e1f5fe','#f3e5f5','#e8f5e9'];
            if(!ARCHIVE_DB.wall) ARCHIVE_DB.wall = [];
            ARCHIVE_DB.wall.push({ t: v, x: Math.random()*70+5, y: Math.random()*70+5, c: colors[Math.floor(Math.random()*colors.length)], r: Math.random()*20-10 });
            document.getElementById('wl-in').value = ""; saveToLocal(); renderWall();
        }
    }
    function deleteFlyer(i) { if(confirm("ë©”ëª¨ë¥¼ ë—„ê¹Œìš”?")) { ARCHIVE_DB.wall.splice(i, 1); saveToLocal(); renderWall(); } }

    function renderGallery() {
        const target = document.getElementById('gal-render');
        if(!target) return;
        target.innerHTML = (ARCHIVE_DB.gallery || []).map((img, i) => `<div class="polaroid-frame" onclick="deletePhoto(${i})"><img src="${img}" style="width:100%; height:250px; object-fit:cover;"></div>`).join('');
    }
    function savePhoto(input) {
        if(input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => { if(!ARCHIVE_DB.gallery) ARCHIVE_DB.gallery = []; ARCHIVE_DB.gallery.push(e.target.result); saveToLocal(); renderGallery(); };
            reader.readAsDataURL(input.files[0]);
        }
    }
    function deletePhoto(i) { if(confirm("ì‚¬ì§„ì„ ì‚­ì œí• ê¹Œìš”?")) { ARCHIVE_DB.gallery.splice(i, 1); saveToLocal(); renderGallery(); } }

    function handleBookClick(i) {
        const b = ARCHIVE_DB.books[i];
        if(confirm(`ğŸ“– [${b.tit}]\n"${b.rev}"\n\nì´ ì±…ì„ ë²„ë¦´ê¹Œìš”?`)) { ARCHIVE_DB.books.splice(i, 1); saveToLocal(); renderBooks(); }
    }
    
    let tempDiaryImg = "";
    function handleDiaryImage(input) {
        if(input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => { tempDiaryImg = e.target.result; alert("ì´ë¯¸ì§€ ì²¨ë¶€ë¨"); };
            reader.readAsDataURL(input.files[0]);
        }
    }
    function deleteDiary(i) { if(confirm("ì‚­ì œ?")) { ARCHIVE_DB.diary.splice(i, 1); saveToLocal(); renderDiary(); } }
    function replyDiary(i) {
        const r = prompt("ë‹µê¸€:"); if(r) { if(!ARCHIVE_DB.diary[i].replies) ARCHIVE_DB.diary[i].replies = []; ARCHIVE_DB.diary[i].replies.push({u: currentUser.name, txt: r}); saveToLocal(); renderDiary(); }
    }
</script>
</body>
</html>