<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Villa 302: The Archive (Final Edition)</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <style>
        /* [Í∏∞Ï°¥ Ïä§ÌÉÄÏùº Ïú†ÏßÄ] */
        :root { --neon-red: #ff3131; --neon-green: #39ff14; --hk-gold: #ffd700; --msg-blue: #007aff; --msg-gray: #e9e9eb; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: white; font-family: -apple-system, sans-serif; overflow: hidden; }
        #entry-page { position: fixed; inset: 0; background: url('villa interior.png') no-repeat center/cover; z-index: 50000; display: flex; justify-content: center; align-items: center; }
        #stage { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100vw; height: 66.67vw; max-width: 150vh; max-height: 100vh; background: url('villa.png') no-repeat center/contain; background-color: #000; }
        #sitemap-btn { position: fixed; top: 25px; left: 25px; width: 50px; height: 50px; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); color: white; cursor: pointer; z-index: 1100; border-radius: 12px; display: none; align-items: center; justify-content: center; }
        
        /* ÌîÑÎ°úÌïÑ Î∞î Ïã§ÏãúÍ∞Ñ Ïó∞ÎèôÏùÑ ÏúÑÌïú Ïä§ÌÉÄÏùº ÏàòÏ†ï */
        #user-indicator { position: fixed; top: 25px; right: 25px; display: none; align-items: center; gap: 10px; background: rgba(0,0,0,0.85); padding: 8px 20px; border: 2px solid var(--neon-green); border-radius: 50px; z-index: 1000; cursor: pointer; }
        #indicator-pic { width: 30px; height: 30px; border-radius: 50%; background-size: cover; background-color: #333; }

        .target { position: absolute; cursor: pointer; z-index: 10; }
        .wall-pos { top: 18%; left: 50%; width: 15%; height: 35%; } 
        .movie-pos { top: 8%; left: 63%; width: 20%; height: 15%; } 
        .cal-pos { top: 45%; left: 74%; width: 8%; height: 20%; } 
        .diary-pos { top: 52%; left: 57%; width: 13%; height: 8%; } 
        .photo-pos { top: 25%; left: 72%; width: 10%; height: 20%; } 
        .lib-pos { top: 35%; left: 35%; width: 12%; height: 25%; } 
        .exit-pos { top: 15%; left: 91%; width: 9%; height: 75%; } 

        .lock-box { background: rgba(0,0,0,0.95); padding: 30px; border-radius: 20px; border: 2px solid var(--neon-red); width: 300px; text-align: center; }
        .user-sel { flex:1; padding:12px; background:#111; color:white; border:1px solid #444; cursor:pointer; }
        .user-sel.active { border: 2px solid var(--neon-green) !important; color: var(--neon-green) !important; }
        .pw-screen { font-size: 2.2rem; color: var(--neon-red); margin-bottom: 20px; letter-spacing: 10px; background: #000; padding: 10px; border: 1px solid #333; height: 50px; }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .key { padding: 20px; background: #111; border: 1px solid #333; cursor: pointer; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; }
        .modal-inner { background: #1c1c1e; width: 90%; max-width: 750px; height: 85vh; border-radius: 25px; padding: 30px; overflow-y: auto; position: relative; color: white; }
        .close-btn { position: absolute; top: 20px; right: 25px; cursor: pointer; font-size: 2.5rem; color: #8e8e93; }

        /* [ÏùºÍ∏∞/Î∞©Î™ÖÎ°ù/Ï∫òÎ¶∞Îçî Ìèº Ïú†ÏßÄ Î∞è Î≥¥Í∞ï] */
        textarea, input { width: 100%; padding: 12px; background: #2c2c2e; border: 1px solid #3a3a3c; color: white; border-radius: 10px; box-sizing: border-box; margin-bottom: 8px; }
        .btn-action { background: var(--msg-blue); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: bold; }
        
        .cal-container { background: #fff; color: #333; border-radius: 15px; padding: 20px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: #eee; }
        .cal-cell { background: #fff; min-height: 80px; padding: 5px; cursor: pointer; }
        .cal-cell.selected { outline: 3px solid var(--msg-blue); z-index: 10; }
        .emo-item { flex: 0 0 auto; width: 70px; text-align: center; cursor: pointer; padding: 10px; border-radius: 10px; border: 1px solid #eee; background: white; }
        .emo-item.active { border: 2px solid var(--msg-blue); background: #f0f7ff; }
        .diary-theme { background: #fff !important; color: #000 !important; }
        .profile-pic { width: 40px; height: 40px; border-radius: 12px; background-size: cover; background-position: center; flex-shrink: 0; }
    </style>
</head>
<body onkeydown="handleGlobalKey(event)">

<div id="player" style="position:fixed; top:-999px;"></div>

<div id="sitemap-btn" onclick="openTab('sitemap')">‚ò∞</div>
<div id="user-indicator" onclick="openTab('profile')">
    <div id="indicator-pic"></div>
    <span id="active-user"></span>
</div>

<div id="entry-page">
    <div class="lock-box">
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button onclick="selectUser('ÌèâÌôî','1231')" id="btn-ÌèâÌôî" class="user-sel">ÌèâÌôî</button>
            <button onclick="selectUser('Ïù∏Ï≤†','0526')" id="btn-Ïù∏Ï≤†" class="user-sel">Ïù∏Ï≤†</button>
        </div>
        <div id="pw-disp" class="pw-screen">----</div>
        <div class="keypad">
            <script>for(let i=1; i<=9; i++) document.write(`<div class="key" onclick="pressKey('${i}')">${i}</div>`);</script>
            <div class="key" onclick="inputPw=''">C</div>
            <div class="key" onclick="pressKey('0')">0</div>
            <div class="key" onclick="checkPw()" style="background:var(--neon-red)">E</div>
        </div>
    </div>
</div>

<div id="stage">
    <div class="target wall-pos" onclick="openTab('wall')"></div>
    <div class="target movie-pos" onclick="openTab('movie')"></div>
    <div class="target cal-pos" onclick="openTab('calendar')"></div>
    <div class="target diary-pos" onclick="openTab('diary')"></div>
    <div class="target photo-pos" onclick="openTab('gallery')"></div>
    <div class="target lib-pos" onclick="openTab('library')"></div>
    <div class="target exit-pos" onclick="exitRoom()"></div>
</div>

<div id="main-modal" class="modal">
    <div class="modal-inner" id="modal-box">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <div id="modal-content"></div>
    </div>
</div>

<script>
    // [1] Firebase ÏÑ§Ï†ï Ïú†ÏßÄ
    const firebaseConfig = {
        apiKey: "AIzaSyDLTGv4Z3zJUseuKw1acvHHwPzooZhXodc",
        databaseURL: "https://villa302-default-rtdb.firebaseio.com",
        projectId: "villa302",
        appId: "1:166700659009:web:18c2872914aab8b4bbf1c0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = "", targetPw = "", inputPw = "";
    let userProfiles = {}, currentCalDate = new Date(), selectedCalKey = "", selectedEmo = "üè†", ytPlayer;

    // [2] BGM ÏãúÏä§ÌÖú (Ïú†ÌäúÎ∏å API)
    function onYouTubeIframeAPIReady() {
        ytPlayer = new YT.Player('player', { height: '0', width: '0', playerVars: { 'autoplay': 1, 'loop': 1 } });
    }
    function loadBGM() {
        db.ref('settings/bgm_v4').on('value', (s) => {
            const id = s.val();
            if(id && ytPlayer && ytPlayer.loadVideoById) ytPlayer.loadVideoById(id);
        });
    }
    function setBGM() {
        const url = document.getElementById('bgm-url').value; if(!url) return;
        let id = url.includes('v=') ? url.split('v=')[1].split('&')[0] : url.split('/').pop();
        db.ref('settings/bgm_v4').set(id); alert("BGM Î≥ÄÍ≤ΩÎê®");
    }

    // [3] ÌîÑÎ°úÌïÑ ÎèôÍ∏∞Ìôî (Ï¶âÏãú Ïó∞Îèô)
    function syncProfiles() {
        db.ref('profiles').on('value', (snapshot) => {
            userProfiles = snapshot.val() || {};
            if(currentUser) {
                const myPic = userProfiles[currentUser] || '';
                document.getElementById('indicator-pic').style.backgroundImage = `url('${myPic}')`;
            }
            // ÏùºÍ∏∞Ïû•Ïù¥ÎÇò Í≤åÏãúÌåêÏù¥ Ïó¥Î†§ÏûàÎã§Î©¥ ÏÉàÎ°úÍ≥†Ïπ® ÏóÜÏù¥ ÌîÑÎ°úÌïÑ Î∞òÏòÅÏùÑ ÏúÑÌï¥ loadÌï®Ïàò Ïû¨Ìò∏Ï∂ú Í∞ÄÎä•
        });
    }

    // [Í∏∞Î≥∏ UI Ìï®Ïàò Ïú†ÏßÄ]
    function handleGlobalKey(e) { if(e.key === "Escape") closeModal(); }
    function selectUser(u, p) { currentUser=u; targetPw=p; inputPw=""; document.querySelectorAll('.user-sel').forEach(b=>b.classList.remove('active')); document.getElementById('btn-'+u).classList.add('active'); updatePwDisp(); }
    function pressKey(n) { if(inputPw.length<4) inputPw+=n; updatePwDisp(); }
    function updatePwDisp() { document.getElementById('pw-disp').innerText = "*".repeat(inputPw.length)||"----"; }
    function checkPw() {
        if(inputPw === targetPw) {
            document.getElementById('entry-page').style.display='none';
            document.getElementById('user-indicator').style.display='flex';
            document.getElementById('sitemap-btn').style.display='flex';
            document.getElementById('active-user').innerText = currentUser;
            syncProfiles(); loadBGM();
        } else { alert("ÎπÑÎ≤à Ïò§Î•ò"); inputPw=""; updatePwDisp(); }
    }
    function exitRoom() { location.reload(); }

    // [4] ÌÉ≠ ÏãúÏä§ÌÖú - Ï∫òÎ¶∞Îçî/BGM/ÌîÑÎ°úÌïÑ
    const tabs = {
        calendar: () => `<div class="cal-container"><h3>üìÖ CALENDAR</h3><div id="cal-render-area"></div>
            <div id="cal-editor" style="display:none; margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
                <p id="cal-edit-title" style="font-weight:bold;"></p>
                <div style="display:flex; gap:10px; overflow-x:auto; padding-bottom:10px;">
                    ${['üè†','üöó','üêü','‚≠ê','üçï','üé¨','ü•∞','üò≠'].map(e => `<div class="emo-item" id="emo-${e}" onclick="selectEmo('${e}')">${e}</div>`).join('')}
                </div>
                <input id="cal-memo-in" style="background:#f0f0f0; color:#000;" placeholder="Ïò§ÎäòÏùò Î©îÎ™®">
                <button class="btn-action" onclick="saveCal()">Í∏∞Î°ùÌïòÍ∏∞</button>
            </div></div>`,
        bgm: () => `<h3>üéµ BGM SETTING</h3><input id="bgm-url" placeholder="Ïú†ÌäúÎ∏å URL ÏûÖÎ†•"><button class="btn-action" onclick="setBGM()">Ï†ÅÏö©ÌïòÍ∏∞</button>`,
        profile: () => `<h3>üë§ PROFILE</h3><div style="text-align:center;">
            <div id="prof-pre" style="width:100px; height:100px; border-radius:50%; margin:20px auto; background-size:cover; background-image:url('${userProfiles[currentUser]||''}')"></div>
            <input type="file" onchange="uploadProfile(this)" style="display:none" id="p-in">
            <button class="btn-action" onclick="document.getElementById('p-in').click()">ÏÇ¨ÏßÑ Î≥ÄÍ≤Ω</button>
        </div>`
    };

    function openTab(id) {
        document.getElementById('modal-content').innerHTML = (tabs[id] ? tabs[id]() : `<h3>Coming Soon</h3>`);
        document.getElementById('main-modal').style.display = 'flex';
        if(id === 'calendar') renderCalendar();
        // ÏùºÍ∏∞/ÏòÅÌôî/ÏÑúÏû¨ Îì± Í∏∞Ï°¥Ïóê ÏûëÎèôÌïòÎçò ÎÇòÎ®∏ÏßÄ Ìï®ÏàòÎì§ÏùÄ Í∏∞Ï°¥ ÏΩîÎìú Í∑∏ÎåÄÎ°ú Ïó¨Í∏∞Ïóê Î∂ôÏó¨ÎÑ£ÏúºÏãúÎ©¥ Îê©ÎãàÎã§.
    }
    function closeModal() { document.getElementById('main-modal').style.display = 'none'; }

    // [5] ÏÉÅÏÑ∏ Í∏∞Îä• Î°úÏßÅ
    function uploadProfile(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const base64 = e.target.result;
            db.ref('profiles/' + currentUser).set(base64);
            document.getElementById('prof-pre').style.backgroundImage = `url(${base64})`;
        };
        reader.readAsDataURL(file);
    }

    function renderCalendar() {
        const year = currentCalDate.getFullYear(), month = currentCalDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay(), days = new Date(year, month+1, 0).getDate();
        db.ref('cal_v4').on('value', (s) => {
            const data = s.val() || {};
            let h = `<div class="cal-header" style="color:#333; display:flex; justify-content:space-between; margin-bottom:10px;">
                <span onclick="moveMonth(-1)">‚óÄ</span> <b>${year}.${month+1}</b> <span onclick="moveMonth(1)">‚ñ∂</span>
            </div><div class="cal-grid">`;
            for(let i=0; i<firstDay; i++) h += `<div class="cal-cell" style="background:#f9f9f9"></div>`;
            for(let d=1; d<=days; d++) {
                const k = `${year}-${month+1}-${d}`, dVal = data[k] || {emo:'', memo:''};
                h += `<div class="cal-cell ${selectedCalKey===k?'selected':''}" onclick="editCal('${k}',${d})">
                    <small style="color:#999">${d}</small><div style="text-align:center; font-size:1.2rem;">${dVal.emo}</div>
                    <div style="font-size:0.6rem; color:#666; overflow:hidden; white-space:nowrap;">${dVal.memo}</div>
                </div>`;
            }
            document.getElementById('cal-render-area').innerHTML = h + `</div>`;
        });
    }
    function moveMonth(n) { currentCalDate.setMonth(currentCalDate.getMonth()+n); renderCalendar(); }
    function editCal(k, d) {
        selectedCalKey = k;
        document.getElementById('cal-editor').style.display = 'block';
        document.getElementById('cal-edit-title').innerText = d + "Ïùº ÏùºÏ†ï";
        db.ref('cal_v4/'+k).once('value', s => {
            const v = s.val() || {emo:'üè†', memo:''};
            document.getElementById('cal-memo-in').value = v.memo;
            selectEmo(v.emo);
        });
    }
    function selectEmo(e) { selectedEmo = e; document.querySelectorAll('.emo-item').forEach(i=>i.classList.remove('active')); document.getElementById('emo-'+e).classList.add('active'); }
    function saveCal() { if(selectedCalKey) db.ref('cal_v4/'+selectedCalKey).set({emo:selectedEmo, memo:document.getElementById('cal-memo-in').value}); }

</script>
</body>
</html>