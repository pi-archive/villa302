<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Villa 302: The Archive</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root { --neon-red: #ff3131; --neon-green: #39ff14; --hk-gold: #ffd700; --msg-blue: #007aff; --msg-gray: #e9e9eb; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: white; font-family: -apple-system, sans-serif; overflow: hidden; }
        
        /* ë©”ì¸ ë¬´ëŒ€ */
        #entry-page { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: url('villa interior.png') no-repeat center center/cover; z-index: 50000; display: flex; justify-content: center; align-items: center; }
        #stage { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100vw; height: 66.67vw; max-width: 150vh; max-height: 100vh; background: url('villa.png') no-repeat center center/contain; background-color: #000; }

        /* UI ê³µí†µ */
        #sitemap-btn { position: fixed; top: 25px; left: 25px; width: 50px; height: 50px; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); color: white; cursor: pointer; z-index: 1100; border-radius: 12px; display: none; align-items: center; justify-content: center; }
        #user-indicator { position: fixed; top: 25px; right: 25px; padding: 12px 25px; border: 2px solid var(--neon-green); border-radius: 30px; color: var(--neon-green); font-weight: bold; z-index: 1000; background: rgba(0,0,0,0.85); display: none; cursor: pointer; }

        /* í´ë¦­ í¬ì¸íŠ¸ */
        .target { position: absolute; cursor: pointer; z-index: 10; }
        .wall-pos { top: 18%; left: 50%; width: 15%; height: 35%; } 
        .movie-pos { top: 8%; left: 63%; width: 20%; height: 15%; } 
        .cal-pos { top: 45%; left: 74%; width: 8%; height: 20%; } 
        .diary-pos { top: 52%; left: 57%; width: 13%; height: 8%; } 
        .photo-pos { top: 25%; left: 72%; width: 10%; height: 20%; } 
        .lib-pos { top: 35%; left: 35%; width: 12%; height: 25%; } 

        /* ëª¨ë‹¬ ì‹œìŠ¤í…œ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; }
        .modal-inner { background: #1c1c1e; width: 90%; max-width: 750px; height: 85vh; border-radius: 25px; padding: 30px; overflow-y: auto; position: relative; color: white; }
        .close-btn { position: absolute; top: 20px; right: 25px; cursor: pointer; font-size: 2.5rem; color: #8e8e93; }

        /* [ì¼ê¸°ì¥] ì•„ì´ë©”ì‹œì§€ UI */
        .diary-theme { background: #fff !important; color: #000 !important; }
        .msg-date-center { text-align: center; font-size: 0.75rem; color: #8e8e93; margin: 20px 0; font-weight: 600; }
        .diary-row { display: flex; margin-bottom: 12px; align-items: flex-end; width: 100%; }
        .profile-pic { width: 35px; height: 35px; border-radius: 50%; background-size: cover; background-position: center; margin: 0 10px; flex-shrink: 0; background-color: #eee; }
        .bubble { max-width: 65%; padding: 10px 16px; border-radius: 20px; font-size: 0.95rem; line-height: 1.4; position: relative; }
        .bubble.mine { background: var(--msg-blue); color: #fff; border-bottom-right-radius: 4px; margin-left: auto; }
        .bubble.yours { background: var(--msg-gray); color: #000; border-bottom-left-radius: 4px; }
        .diary-actions { font-size: 0.7rem; opacity: 0.5; margin-top: 4px; display: flex; gap: 8px; cursor: pointer; }
        .reply-box { font-size: 0.8rem; padding: 4px 12px; margin: 5px 0 10px 55px; color: #666; border-left: 2px solid #ddd; }

        /* [ì‚¬ì§„ì²©] ì¸ìŠ¤íƒ€ê·¸ë¨ í”¼ë“œ ìŠ¤íƒ€ì¼ */
        .insta-feed { display: flex; flex-direction: column; gap: 30px; }
        .insta-post { background: #000; border: 1px solid #333; border-radius: 8px; overflow: hidden; }
        .insta-img { width: 100%; display: block; }
        .insta-desc { padding: 15px; font-size: 0.9rem; border-bottom: 1px solid #222; }
        .insta-comments { padding: 10px 15px; background: #111; font-size: 0.85rem; }

        /* [ë‹´ë²¼ë½] ì „ë‹¨ì§€ ë ˆì´ì•„ì›ƒ */
        #wall-board { height: 500px; position: relative; background: #222; overflow: hidden; border: 4px solid #444; margin-top: 15px; }
        .flyer { position: absolute; background: #fffce0; color: #333; padding: 15px; width: 130px; box-shadow: 5px 5px 15px rgba(0,0,0,0.4); font-family: 'Nanum Pen Script', cursive; font-size: 1.3rem; }
        .flyer-x { position: absolute; top: 2px; right: 5px; cursor: pointer; font-family: sans-serif; font-size: 0.8rem; color: #999; }
        .flyer-fringe { position: absolute; bottom: 0; left: 0; width: 100%; height: 20px; display: flex; justify-content: space-around; }
        .fringe-bit { width: 1px; height: 100%; background: rgba(0,0,0,0.1); }

        /* [ìº˜ë¦°ë”] ê³ ë„í™” UI */
        .cal-container { background: #fff; color: #333; border-radius: 15px; padding: 15px; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: #eee; border: 1px solid #eee; }
        .cal-cell { background: #fff; min-height: 70px; padding: 5px; cursor: pointer; }
        .cal-cell.today { background: #fffde7; }
        .cal-cell.selected { outline: 2px solid var(--msg-blue); z-index: 5; }
        .emo-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 10px; }
        .emo-item { flex: 0 0 auto; width: 60px; text-align: center; cursor: pointer; padding: 8px; border-radius: 10px; border: 1px solid #ddd; }
        .emo-item.active { border-color: var(--msg-blue); background: #f0f7ff; }

        /* [ì ê¸ˆ/ì…ë ¥] */
        .btn-action { background: var(--msg-blue); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }
        textarea, input { width: 100%; padding: 12px; background: #2c2c2e; border: 1px solid #3a3a3c; color: white; border-radius: 10px; box-sizing: border-box; margin-bottom: 8px; }
    </style>
</head>
<body onkeydown="handleGlobalKey(event)">

<div id="bgm-container"></div>
<div id="sitemap-btn" onclick="openTab('sitemap')">â˜°</div>
<div id="user-indicator" onclick="openTab('profile')">ACCESS: <span id="active-user"></span></div>

<div id="entry-page">
    <div class="lock-box" style="background:rgba(0,0,0,0.9); padding:30px; border:2px solid var(--neon-red); border-radius:20px; width:300px; text-align:center;">
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button onclick="selectUser('í‰í™”','1231')" id="btn-í‰í™”" class="user-sel" style="flex:1; padding:10px; background:#111; color:white; cursor:pointer;">í‰í™”</button>
            <button onclick="selectUser('ì¸ì² ','0526')" id="btn-ì¸ì² " class="user-sel" style="flex:1; padding:10px; background:#111; color:white; cursor:pointer;">ì¸ì² </button>
        </div>
        <div id="pw-disp" style="font-size:2rem; color:var(--neon-red); margin-bottom:20px; letter-spacing:10px;">----</div>
        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px;">
            <script>for(let i=1; i<=9; i++) document.write(`<button onclick="pressKey('${i}')" style="padding:15px; background:#222; color:white; border:none; cursor:pointer;">${i}</button>`);</script>
            <button onclick="inputPw=''" style="padding:15px; background:#222; color:white; border:none;">C</button>
            <button onclick="pressKey('0')" style="padding:15px; background:#222; color:white; border:none;">0</button>
            <button onclick="checkPw()" style="padding:15px; background:var(--neon-red); color:white; border:none;">E</button>
        </div>
    </div>
</div>

<div id="stage">
    <div class="target wall-pos" onclick="openTab('wall')"></div>
    <div class="target movie-pos" onclick="openTab('movie')"></div>
    <div class="target cal-pos" onclick="openTab('calendar')"></div>
    <div class="target diary-pos" onclick="openTab('diary')"></div>
    <div class="target photo-pos" onclick="openTab('gallery')"></div>
    <div class="target lib-pos" onclick="openTab('library')"></div>
</div>

<div id="main-modal" class="modal">
    <div class="modal-inner" id="modal-box">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <div id="modal-content"></div>
    </div>
</div>

<script>
    // Firebase ì´ˆê¸°í™”
    const firebaseConfig = {
        apiKey: "AIzaSyDLTGv4Z3zJUseuKw1acvHHwPzooZhXodc",
        authDomain: "villa302.firebaseapp.com",
        databaseURL: "https://villa302-default-rtdb.firebaseio.com",
        projectId: "villa302",
        storageBucket: "villa302.firebasestorage.app",
        messagingSenderId: "166700659009",
        appId: "1:166700659009:web:18c2872914aab8b4bbf1c0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = "", targetPw = "", inputPw = "";
    let userProfiles = {};
    let currentCalDate = new Date();
    let selectedCalKey = "";
    let selectedEmo = "ğŸ ";

    // ê³µí†µ í•¨ìˆ˜
    function selectUser(u, p) { 
        currentUser = u; targetPw = p; inputPw = ""; 
        document.querySelectorAll('.user-sel').forEach(b => b.style.borderColor = "#444");
        document.getElementById('btn-'+u).style.borderColor = "var(--neon-green)";
        updatePwDisp(); 
    }
    function pressKey(n) { if(inputPw.length < 4) inputPw += n; updatePwDisp(); }
    function updatePwDisp() { document.getElementById('pw-disp').innerText = "*".repeat(inputPw.length) || "----"; }
    function checkPw() { 
        if(inputPw === targetPw) { 
            document.getElementById('entry-page').style.display='none'; 
            document.getElementById('user-indicator').style.display='block'; 
            document.getElementById('sitemap-btn').style.display='flex'; 
            document.getElementById('active-user').innerText = currentUser;
            db.ref('profiles').on('value', s => { userProfiles = s.val() || {}; });
            loadBGM();
        } else { alert("Error"); inputPw=""; updatePwDisp(); }
    }
    function handleGlobalKey(e) { if(e.key === "Escape") closeModal(); }
    function closeModal() { document.getElementById('main-modal').style.display = 'none'; }

    // ëª¨ë‹¬ ë¶„ê¸°
    function openTab(id) {
        const box = document.getElementById('modal-box');
        const content = document.getElementById('modal-content');
        id === 'diary' ? box.classList.add('diary-theme') : box.classList.remove('diary-theme');

        const tabs = {
            profile: () => `<h3>ğŸ‘¤ í”„ë¡œí•„ ì„¤ì •</h3>
                <div style="text-align:center;">
                    <div id="prof-pre" style="width:100px; height:100px; border-radius:50%; margin:20px auto; background-size:cover; background-position:center; background-image:url('${userProfiles[currentUser]||''}')"></div>
                    <input type="file" id="p-file" accept="image/*" onchange="saveProfile(this)">
                </div>`,
            diary: () => `<h3>ğŸ“” DIARY</h3><div id="diary-chat" style="height:400px; overflow-y:auto; padding:10px;"></div>
                <div style="padding-top:15px;"><textarea id="d-in" placeholder="iMessage"></textarea><button class="btn-action" onclick="saveDiary()">ì „ì†¡</button></div>`,
            gallery: () => `<h3>ğŸ“¸ PHOTO FEED</h3><input type="file" id="g-file" accept="image/*"><input id="g-desc" placeholder="ì‚¬ì§„ ì„¤ëª…"><button class="btn-action" onclick="saveGallery()">ì—…ë¡œë“œ</button>
                <div id="g-list" class="insta-feed" style="margin-top:20px;"></div>`,
            wall: () => `<h3>ğŸ§± WALL</h3><input id="w-in" placeholder="ë‚´ìš© ì…ë ¥"><button class="btn-action" onclick="saveWall()">í¬ìŠ¤íŠ¸ì‡ ë¶™ì´ê¸°</button><div id="wall-board"></div>`,
            calendar: () => `<h3>ğŸ“… CALENDAR</h3><div id="cal-render"></div><div id="cal-edit" style="display:none; margin-top:20px; color:#333; background:#f9f9f9; padding:15px; border-radius:10px;">
                <div class="emo-scroll">${["ğŸ ","ğŸš—","ğŸŸ","â­","ğŸ•","ğŸ¬","ğŸº","ğŸ¥°","ğŸ˜­"].map(e => `<div class="emo-item" id="emo-${e}" onclick="selectedEmo='${e}'; renderCalendar();">${e}</div>`).join('')}</div>
                <input id="cal-m-in" placeholder="ë©”ëª¨" style="background:#fff; color:#000;"><button class="btn-action" onclick="saveCal()">ì €ì¥</button><button onclick="delCal()" style="color:red; margin-top:10px; background:none; border:none; width:100%;">ì‚­ì œí•˜ê¸°</button></div>`,
            library: () => `<h3>ğŸ“š LIBRARY</h3><button class="btn-action" onclick="writeBook()">+ ìƒˆë¡œìš´ ê¸€</button><div id="lib-shelf" class="bookshelf-grid" style="margin-top:20px; display:grid; grid-template-columns:repeat(auto-fill, minmax(40px,1fr));"></div>`,
            sitemap: () => `<div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">${['diary','movie','calendar','wall','library','gallery'].map(t=>`<button class="btn-action" onclick="openTab('${t}')">${t.toUpperCase()}</button>`).join('')}</div>`
        };

        content.innerHTML = (tabs[id] || (() => `<h3>ì¤€ë¹„ ì¤‘</h3>`))();
        document.getElementById('main-modal').style.display = 'flex';

        if(id==='diary') loadDiary();
        if(id==='gallery') loadGallery();
        if(id==='wall') loadWall();
        if(id==='calendar') renderCalendar();
        if(id==='library') loadShelf();
    }

    // --- ê¸°ëŠ¥ ë¡œì§ ---

    function saveProfile(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = e => db.ref('profiles/'+currentUser).set(e.target.result).then(()=>alert("í”„ë¡œí•„ ì €ì¥ë¨"));
        reader.readAsDataURL(file);
    }

    function saveDiary() {
        const t = document.getElementById('d-in').value; if(!t) return;
        db.ref('diary_v3').push({ u: currentUser, t, d: new Date().toLocaleDateString('ko-KR', {month:'long', day:'numeric', weekday:'short'}), ts: Date.now() });
        document.getElementById('d-in').value = "";
    }
    function loadDiary() {
        db.ref('diary_v3').on('value', s => {
            const chat = document.getElementById('diary-chat'); if(!chat) return;
            let lastD = "";
            chat.innerHTML = s.val() ? Object.entries(s.val()).map(([k,v]) => {
                let h = v.d !== lastD ? `<div class="msg-date-center">${v.d}</div>` : ""; lastD = v.d;
                const mine = v.u === currentUser;
                return `${h}<div class="diary-row" style="flex-direction:${mine?'row-reverse':''}">
                    <div class="profile-pic" style="background-image:url('${userProfiles[v.u]||''}')"></div>
                    <div class="bubble ${mine?'mine':'yours'}">${v.t}</div>
                </div>
                <div class="diary-actions" style="justify-content:${mine?'flex-end':''}">
                    <span onclick="replyDiary('${k}')">ëŒ“ê¸€</span>
                    ${mine?`<span onclick="editDiary('${k}','${v.t}')">ìˆ˜ì •</span><span onclick="delDiary('${k}')">ì‚­ì œ</span>`:''}
                </div>${v.reps?Object.values(v.reps).map(r=>`<div class="reply-box"><b>${r.u}</b>: ${r.t}</div>`).join(''):''}`;
            }).join('') : '';
            chat.scrollTop = chat.scrollHeight;
        });
    }
    function delDiary(k) { if(confirm("ì‚­ì œí• ê¹Œìš”?")) db.ref(`diary_v3/${k}`).remove(); }
    function editDiary(k, o) { const n = prompt("ìˆ˜ì •:", o); if(n) db.ref(`diary_v3/${k}`).update({t:n}); }
    function replyDiary(k) { const r = prompt("ëŒ“ê¸€:"); if(r) db.ref(`diary_v3/${k}/reps`).push({u:currentUser, t:r}); }

    function saveGallery() {
        const file = document.getElementById('g-file').files[0], desc = document.getElementById('g-desc').value;
        if(!file) return;
        const reader = new FileReader();
        reader.onload = e => db.ref('gallery_v3').push({ img: e.target.result, desc, u: currentUser });
        reader.readAsDataURL(file);
    }
    function loadGallery() {
        db.ref('gallery_v3').on('value', s => {
            const cont = document.getElementById('g-list'); if(!cont) return;
            cont.innerHTML = s.val() ? Object.entries(s.val()).reverse().map(([k,v]) => `
                <div class="insta-post">
                    <img src="${v.img}" class="insta-img">
                    <div class="insta-desc"><b>${v.u}</b> ${v.desc}</div>
                    <div class="insta-comments">
                        <div style="cursor:pointer; opacity:0.6;" onclick="replyG('${k}')">ëŒ“ê¸€ ë‹¬ê¸°...</div>
                        ${v.reps?Object.values(v.reps).map(r=>`<div><b>${r.u}</b> ${r.t}</div>`).join(''):''}
                    </div>
                </div>`).join('') : '';
        });
    }
    function replyG(k) { const t = prompt("ëŒ“ê¸€:"); if(t) db.ref(`gallery_v3/${k}/reps`).push({u:currentUser, t}); }

    function saveWall() {
        const t = document.getElementById('w-in').value; if(!t) return;
        db.ref('wall_v4').push({ t, x: Math.random()*70, y: Math.random()*70, rot: (Math.random()*10-5) });
        document.getElementById('w-in').value = "";
    }
    function loadWall() {
        db.ref('wall_v4').on('value', s => {
            const b = document.getElementById('wall-board'); if(!b) return;
            b.innerHTML = s.val() ? Object.entries(s.val()).map(([k,v]) => `
                <div class="flyer" style="left:${v.x}%; top:${v.y}%; transform:rotate(${v.rot}deg)">
                    <span class="flyer-x" onclick="delWall('${k}')">âœ•</span>${v.t}
                    <div class="flyer-fringe">${Array(10).fill('<div class="fringe-bit"></div>').join('')}</div>
                </div>`).join('') : '';
        });
    }
    function delWall(k) { if(confirm("ë–¼ì‹œê² ìŠµë‹ˆê¹Œ?")) db.ref(`wall_v4/${k}`).remove(); }

    function renderCalendar() {
        const y = currentCalDate.getFullYear(), m = currentCalDate.getMonth();
        db.ref('cal_v4').on('value', s => {
            const data = s.val() || {};
            let html = `<div class="cal-container"><div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold;">
                <span onclick="currentCalDate.setMonth(currentCalDate.getMonth()-1); renderCalendar()">â—€</span> ${y}ë…„ ${m+1}ì›” <span onclick="currentCalDate.setMonth(currentCalDate.getMonth()+1); renderCalendar()">â–¶</span>
                </div><div class="cal-grid">${['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].map(d=>`<div style="text-align:center; font-size:0.7rem;">${d}</div>`).join('')}`;
            const first = new Date(y, m, 1).getDay(), total = new Date(y, m+1, 0).getDate();
            for(let i=0; i<first; i++) html += `<div></div>`;
            for(let d=1; d<=total; d++) {
                const k = `${y}-${m+1}-${d}`;
                const has = data[k] || { emo:'', memo:'' };
                html += `<div class="cal-cell ${selectedCalKey===k?'selected':''}" onclick="selectCal('${k}', ${d})">
                    <div style="font-size:0.7rem;">${d}</div><div style="text-align:center; font-size:1.2rem;">${has.emo}</div><div style="font-size:0.6rem; overflow:hidden;">${has.memo}</div>
                </div>`;
            }
            const area = document.getElementById('cal-render'); if(area) area.innerHTML = html + "</div></div>";
            document.querySelectorAll('.emo-item').forEach(e => e.classList.remove('active'));
            if(document.getElementById('emo-'+selectedEmo)) document.getElementById('emo-'+selectedEmo).classList.add('active');
        });
    }
    function selectCal(k, d) {
        selectedCalKey = k;
        document.getElementById('cal-edit').style.display = 'block';
        db.ref(`cal_v4/${k}`).once('value', s => { 
            const v = s.val() || {emo:'ğŸ ', memo:''};
            document.getElementById('cal-m-in').value = v.memo;
            selectedEmo = v.emo; renderCalendar();
        });
    }
    function saveCal() { db.ref(`cal_v4/${selectedCalKey}`).set({ emo: selectedEmo, memo: document.getElementById('cal-memo-in' || 'cal-m-in').value }).then(()=>alert("ì €ì¥ë¨")); }
    function delCal() { if(confirm("ì¼ì •ì„ ì‚­ì œí• ê¹Œìš”?")) db.ref(`cal_v4/${selectedCalKey}`).remove(); }

    function writeBook() {
        const t = prompt("ì œëª©:"), c = prompt("ë‚´ìš©:");
        if(t && c) db.ref('lib_v4').push({ t, c, color: '#'+Math.floor(Math.random()*16777215).toString(16) });
    }
    function loadShelf() {
        db.ref('lib_v4').on('value', s => {
            const shelf = document.getElementById('lib-shelf'); if(!shelf) return;
            shelf.innerHTML = s.val() ? Object.entries(s.val()).map(([k,v])=>`<div onclick="viewBook('${k}')" style="background:${v.color}; width:35px; height:120px; writing-mode:vertical-rl; padding:5px; cursor:pointer; color:white;">${v.t}</div>`).join('') : '';
        });
    }
    function viewBook(k) {
        db.ref(`lib_v4/${k}`).once('value', s => {
            const v = s.val();
            document.getElementById('modal-content').innerHTML = `<div style="background:#fdfcf0; color:#333; padding:30px; height:100%; border-left:15px solid ${v.color}">
                <h2>${v.t}</h2><hr><p style="white-space:pre-wrap; line-height:2;">${v.c}</p>
                <button class="btn-action" onclick="openTab('library')">ëª©ë¡ìœ¼ë¡œ</button>
                <button onclick="if(confirm('ì‚­ì œ?')){db.ref('lib_v4/${k}').remove(); openTab('library');}" style="color:red; background:none; border:none; margin-top:30px;">ê¸€ ì‚­ì œ</button>
            </div>`;
        });
    }

    function loadBGM() {
        db.ref('settings/bgm').on('value', s => {
            const id = s.val(); if(id) document.getElementById('bgm-container').innerHTML = `<iframe width="0" height="0" src="https://www.youtube.c<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Villa 302: Final Archive</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root { --neon-red: #ff3131; --neon-green: #39ff14; --msg-blue: #007aff; --msg-gray: #e9e9eb; --apple-bg: #1c1c1e; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: white; overflow: hidden; font-family: -apple-system, sans-serif; }
        
        /* [1] ì…ì¥ í™”ë©´ */
        #entry-page { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: url('villa interior.png') no-repeat center center/cover; z-index: 50000; display: flex; justify-content: center; align-items: center; }
        .lock-box { background: rgba(0,0,0,0.92); backdrop-filter: blur(25px); padding: 40px; border-radius: 35px; border: 1px solid rgba(255,255,255,0.1); width: 320px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .user-sel-btn { flex: 1; padding: 15px; background: #111; color: white; border: 2px solid #333; border-radius: 12px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .user-sel-btn.active { border-color: var(--neon-green); color: var(--neon-green); background: rgba(57,255,20,0.1); }
        #pw-disp { font-size: 3rem; color: var(--neon-red); margin-bottom: 25px; height: 50px; letter-spacing: 10px; display: flex; justify-content: center; align-items: center; text-shadow: 0 0 10px var(--neon-red); }
        .key-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .key { padding: 20px; background: rgba(255,255,255,0.1); border-radius: 12px; cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
        .key:active { background: rgba(255,255,255,0.2); transform: scale(0.95); }

        /* [2] ë©”ì¸ ê±°ì‹¤ ìŠ¤í…Œì´ì§€ */
        #stage { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100vw; height: 66.67vw; max-width: 150vh; max-height: 100vh; background: url('villa.png') no-repeat center center/contain; background-color: #000; }
        .target { position: absolute; cursor: pointer; z-index: 10; border-radius: 10px; }
        .target:hover { background: rgba(255,255,255,0.15); box-shadow: 0 0 20px rgba(255,255,255,0.1); }
        .wall-pos { top: 18%; left: 50%; width: 15%; height: 35%; } 
        .movie-pos { top: 8%; left: 63%; width: 20%; height: 15%; } 
        .cal-pos { top: 45%; left: 74%; width: 8%; height: 20%; } 
        .diary-pos { top: 52%; left: 57%; width: 13%; height: 8%; } 
        .photo-pos { top: 25%; left: 72%; width: 10%; height: 20%; } 
        .lib-pos { top: 35%; left: 35%; width: 12%; height: 25%; } 

        /* [3] ëª¨ë‹¬ ì‹œìŠ¤í…œ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 10000; justify-content: center; align-items: center; }
        .modal-inner { background: var(--apple-bg); width: 92%; max-width: 800px; height: 85vh; border-radius: 30px; padding: 30px; overflow-y: auto; position: relative; border: 1px solid #333; }
        .close-btn { position: absolute; top: 20px; right: 30px; font-size: 2.5rem; color: #888; cursor: pointer; z-index: 100; }

        /* [4] ê¸°ëŠ¥ë³„ ìŠ¤íƒ€ì¼ ìƒì„¸ (ë¡œì§ í™•ì¥) */
        /* ì¼ê¸°ì¥(iMessage) */
        .diary-theme { background: #fff !important; color: #000 !important; }
        #diary-chat { height: calc(100% - 150px); overflow-y: auto; padding: 15px; display: flex; flex-direction: column; }
        .diary-row { display: flex; margin-bottom: 12px; align-items: flex-end; }
        .profile-img { width: 35px; height: 35px; border-radius: 50%; background-size: cover; background-position: center; margin: 0 10px; background-color: #eee; flex-shrink: 0; }
        .bubble { max-width: 65%; padding: 12px 16px; border-radius: 20px; font-size: 0.95rem; line-height: 1.4; }
        .bubble.mine { background: var(--msg-blue); color: #fff; margin-left: auto; border-bottom-right-radius: 4px; }
        .bubble.yours { background: var(--msg-gray); color: #000; border-bottom-left-radius: 4px; }

        /* ì˜í™”(Movie) */
        .mv-card { background: #2c2c2e; padding: 20px; border-radius: 15px; margin-bottom: 20px; border-left: 5px solid var(--neon-red); }
        .star-rating { color: #ffd700; margin-bottom: 8px; }

        /* ê°¤ëŸ¬ë¦¬(Insta) */
        .insta-post { background: #000; border: 1px solid #333; margin-bottom: 30px; border-radius: 12px; overflow: hidden; }
        .insta-header { padding: 12px; display: flex; align-items: center; gap: 10px; font-weight: bold; }
        .insta-img { width: 100%; aspect-ratio: 1/1; background-size: cover; background-position: center; }
        .insta-body { padding: 12px; font-size: 0.9rem; }

        /* ë°©ëª…ë¡(Wall) */
        .leaflet-box { display: flex; flex-wrap: wrap; gap: 15px; }
        .leaflet { background: #fff9c4; color: #333; width: 140px; padding: 15px; font-family: 'Nanum Pen Script'; font-size: 1.4rem; box-shadow: 3px 3px 10px rgba(0,0,0,0.3); transform: rotate(-1deg); }

        /* ìº˜ë¦°ë” & ì„œì¬ */
        .cal-table { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: #444; border: 1px solid #444; }
        .cal-day { background: #fff; color: #000; min-height: 80px; padding: 5px; cursor: pointer; font-weight: bold; }
        .book-item { background: #2c2c2e; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 5px solid var(--neon-green); }

        /* ê³µí†µ UI */
        input, textarea, select { width: 100%; padding: 14px; background: #2c2c2e; border: 1px solid #3a3a3c; color: white; border-radius: 12px; margin-bottom: 10px; box-sizing: border-box; }
        .btn-send { background: var(--msg-blue); color: white; border: none; padding: 15px; border-radius: 12px; width: 100%; cursor: pointer; font-weight: bold; }
        #sitemap-btn { position: fixed; top: 25px; left: 25px; z-index: 1100; cursor: pointer; font-size: 1.5rem; background: rgba(255,255,255,0.1); width: 50px; height: 50px; border-radius: 12px; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); }
    </style>
</head>
<body>

<div id="bgm-player" style="position:fixed; top:-5000px;"><div id="player"></div></div>
<div id="sitemap-btn" onclick="openTab('sitemap')">â˜°</div>

<div id="entry-page">
    <div class="lock-box">
        <h2 style="color:white; margin-bottom:20px; letter-spacing: 2px;">VILLA 302</h2>
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button onclick="selU('í‰í™”','1231')" id="b-í‰í™”" class="user-sel-btn">í‰í™”</button>
            <button onclick="selU('ì¸ì² ','0526')" id="b-ì¸ì² " class="user-sel-btn">ì¸ì² </button>
        </div>
        <div id="pw-disp">----</div>
        <div class="key-grid">
            <script>for(let i=1; i<=9; i++) document.write(`<div class="key" onclick="press('${i}')">${i}</div>`);</script>
            <div class="key" onclick="inputPw=''; updatePw();">C</div>
            <div class="key" onclick="press('0')">0</div>
            <div class="key" style="background:var(--neon-red)" onclick="checkPw()">E</div>
        </div>
    </div>
</div>

<div id="stage">
    <div class="target wall-pos" onclick="openTab('wall')"></div>
    <div class="target movie-pos" onclick="openTab('movie')"></div>
    <div class="target cal-pos" onclick="openTab('calendar')"></div>
    <div class="target diary-pos" onclick="openTab('diary')"></div>
    <div class="target photo-pos" onclick="openTab('gallery')"></div>
    <div class="target lib-pos" onclick="openTab('library')"></div>
</div>

<div id="main-modal" class="modal">
    <div class="modal-inner" id="modal-box">
        <span class="close-btn" onclick="closeModal()">Ã—</span>
        <div id="modal-content"></div>
    </div>
</div>

<script>
    // --- [Firebase ì´ˆê¸°í™”] ---
    const firebaseConfig = {
        apiKey: "AIzaSyDLTGv4Z3zJUseuKw1acvHHwPzooZhXodc",
        databaseURL: "https://villa302-default-rtdb.firebaseio.com",
        projectId: "villa302",
        appId: "1:166700659009:web:18c2872914aab8b4bbf1c0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = "", targetPw = "", inputPw = "", userProfiles = {}, player;

    // --- [ì¸ì¦ & ì…ì¥ ë¡œì§] ---
    function selU(u,p) { currentUser=u; targetPw=p; inputPw=""; document.querySelectorAll('.user-sel-btn').forEach(b=>b.classList.remove('active')); document.getElementById('b-'+u).classList.add('active'); updatePw(); }
    function press(n) { if(inputPw.length<4) inputPw+=n; updatePw(); }
    function updatePw() { document.getElementById('pw-disp').innerText = "*".repeat(inputPw.length)||"----"; }
    
    function checkPw() {
        if(inputPw === targetPw) {
            document.getElementById('entry-page').style.display='none';
            document.getElementById('sitemap-btn').style.display='flex';
            db.ref('profiles').on('value', s => { userProfiles = s.val() || {}; });
            initBGM();
        } else { alert("ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜"); inputPw=""; updatePw(); }
    }

    // --- [BGM ë¡œì§ - ì´ì „ ì½”ë“œì—ì„œ ë³µêµ¬] ---
    var tag = document.createElement('script'); tag.src = "https://www.youtube.com/iframe_api";
    document.getElementsByTagName('script')[0].parentNode.insertBefore(tag, null);
    function initBGM() {
        player = new YT.Player('player', { height: '0', width: '0', events: { 'onReady': () => {
            db.ref('bgm_vfinal').on('value', s => {
                const data = s.val(); if(!data) return;
                const ids = Object.values(data).map(i => i.id);
                player.loadPlaylist({ playlist: ids.join(','), listType: 'playlist' });
            });
        }}});
    }

    // --- [íƒ­ ì‹œìŠ¤í…œ] ---
    function openTab(id) {
        const box = document.getElementById('modal-box');
        const content = document.getElementById('modal-content');
        box.className = (id === 'diary' ? 'modal-inner diary-theme' : 'modal-inner');
        document.getElementById('main-modal').style.display = 'flex';
        
        if(id === 'sitemap') {
            content.innerHTML = `<h3>SITEMAP</h3><div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
                ${['diary','wall','gallery','movie','calendar','library','bgm','profile'].map(t=>`<button class="btn-send" style="background:#333;" onclick="openTab('${t}')">${t.toUpperCase()}</button>`).join('')}
            </div>`;
        } else if(id === 'movie') {
            content.innerHTML = `<h3>ğŸ¬ MOVIE ì•„ì¹´ì´ë¸Œ</h3><input id="mv-t" placeholder="ì˜í™” ì œëª©"><textarea id="mv-r" placeholder="ê°ìƒí‰"></textarea>
                <select id="mv-s"><option value="5">â­â­â­â­â­</option><option value="4">â­â­â­â­</option><option value="3">â­â­â­</option></select>
                <button class="btn-send" onclick="addMv()">ì €ì¥í•˜ê¸°</button><div id="mv-list" style="margin-top:20px;"></div>`;
            renderMv();
        } else if(id === 'diary') {
            content.innerHTML = `<h3>ğŸ“” DIARY</h3><div id="diary-chat"></div>
                <div style="display:flex; gap:10px; margin-top:10px;"><textarea id="dy-in" placeholder="ë‚´ìš©..."></textarea>
                <button class="btn-send" style="width:80px;" onclick="addDy()">â†‘</button></div>`;
            renderDy();
        } else if(id === 'wall') {
            content.innerHTML = `<h3>ğŸ§± THE WALL</h3><textarea id="wl-in" placeholder="ë¶™ì¼ ë©”ì‹œì§€"></textarea><button class="btn-send" onclick="addWl()">ë²½ì— ë¶™ì´ê¸°</button>
                <div class="leaflet-box" id="wl-list" style="margin-top:20px;"></div>`;
            renderWl();
        } else if(id === 'gallery') {
            content.innerHTML = `<h3>ğŸ“¸ GALLERY</h3><input type="file" onchange="addGal(this)"><div id="gal-list" style="margin-top:20px;"></div>`;
            renderGal();
        } else if(id === 'calendar') {
            content.innerHTML = `<h3>ğŸ“… 10ì›” CALENDAR</h3><div id="cal-list" class="cal-table"></div>
                <div id="cal-ctrl" style="display:none; margin-top:15px; background:#fff; padding:15px; border-radius:15px; color:#000; text-align:center;">
                <p>ì˜¤ëŠ˜ì˜ ê¸°ë¶„ ê¸°ë¡:</p><div style="display:flex; gap:15px; font-size:2rem; justify-content:center;">${['ğŸ ','ğŸ¬','ğŸº','â¤ï¸','ğŸ˜­','â­'].map(e=>`<span onclick="saveCal('${e}')" style="cursor:pointer;">${e}</span>`).join('')}</div></div>`;
            renderCal();
        } else if(id === 'library') {
            content.innerHTML = `<h3>ğŸ“š LIBRARY</h3><input id="bk-t" placeholder="ë„ì„œëª…"><input id="bk-d" type="date">
                <select id="bk-st"><option>ì½ëŠ” ì¤‘</option><option>ì™„ë…</option></select>
                <button class="btn-send" onclick="addBk()">ì„œì¬ ë“±ë¡</button><div id="bk-list" style="margin-top:20px;"></div>`;
            renderBk();
        } else if(id === 'bgm') {
            content.innerHTML = `<h3>ğŸµ BGM MANAGER</h3><input id="bgm-in" placeholder="ìœ íŠœë¸Œ ë§í¬ ë˜ëŠ” ID"><button class="btn-send" onclick="addBgm()">ì¬ìƒ ëª©ë¡ ì¶”ê°€</button><div id="bgm-list" style="margin-top:20px;"></div>`;
            renderBgm();
        } else if(id === 'profile') {
            content.innerHTML = `<h3>ğŸ‘¤ PROFILE</h3><div style="text-align:center;">
                <div id="pf-pre" style="width:120px; height:120px; border-radius:50%; margin:0 auto 20px; background-size:cover; border:3px solid var(--neon-green); background-image:url('${userProfiles[currentUser]||''}')"></div>
                <input type="file" onchange="prePf(this)"><button class="btn-send" onclick="savePf()">ì‚¬ì§„ ì €ì¥</button></div>`;
        }
    }

    // --- [í•µì‹¬ ë¡œì§ í†µí•©] ---
    function addMv() { const t=document.getElementById('mv-t').value, r=document.getElementById('mv-r').value, s=document.getElementById('mv-s').value; if(t) db.ref('mv_final').push({t, r, s, u:currentUser}); }
    function renderMv() {
        db.ref('mv_final').on('value', s => {
            const d=s.val(); const div=document.getElementById('mv-list'); if(!div||!d) return;
            div.innerHTML = Object.keys(d).reverse().map(k=>`
                <div class="mv-card">
                    <b>${d[k].t}</b> <div class="star-rating">${'â˜…'.repeat(d[k].s)}</div>
                    <p style="font-size:0.9rem; color:#ccc;">${d[k].r}</p>
                    <small style="color:gray;">Writer: ${d[k].u}</small>
                    ${d[k].u===currentUser?`<span style="float:right; color:red; cursor:pointer;" onclick="db.ref('mv_final/${k}').remove()">ì‚­ì œ</span>`:''}
                </div>`).join('');
        });
    }

    function addDy() { const t=document.getElementById('dy-in').value; if(t) db.ref('dy_final').push({t, u:currentUser, ts:Date.now()}); document.getElementById('dy-in').value=""; }
    function renderDy() {
        db.ref('dy_final').on('value', s => {
            const d=s.val(); const div=document.getElementById('diary-chat'); if(!div||!d) return;
            div.innerHTML = Object.keys(d).map(k => {
                const isM = d[k].u===currentUser;
                return `<div class="diary-row" style="flex-direction:${isM?'row-reverse':'row'}">
                    <div class="profile-img" style="background-image:url('${userProfiles[d[k].u]||''}')"></div>
                    <div class="bubble ${isM?'mine':'yours'}" onclick="if('${d[k].u}'==='${currentUser}' && confirm('ì‚­ì œ?')) db.ref('dy_final/${k}').remove()">${d[k].t}</div></div>`;
            }).join('');
            div.scrollTop = div.scrollHeight;
        });
    }

    function addWl() { const t=document.getElementById('wl-in').value; if(t) db.ref('wl_final').push({t, u:currentUser}); document.getElementById('wl-in').value=""; }
    function renderWl() {
        db.ref('wl_final').on('value', s => {
            const d=s.val(); const div=document.getElementById('wl-list'); if(!div||!d) {div.innerHTML=""; return;}
            div.innerHTML = Object.keys(d).map(k => `<div class="leaflet">${d[k].t}<br><small>- From. ${d[k].u}</small>
                <span style="position:absolute; top:2px; right:5px; font-size:0.8rem; cursor:pointer;" onclick="db.ref('wl_final/${k}').remove()">Ã—</span></div>`).join('');
        });
    }

    function addGal(i) { if(i.files[0]) { const r=new FileReader(); r.onload=e=>db.ref('gal_final').push({img:e.target.result, u:currentUser}); r.readAsDataURL(i.files[0]); } }
    function renderGal() {
        db.ref('gal_final').on('value', s => {
            const d=s.val(); const div=document.getElementById('gal-list'); if(!div||!d) return;
            div.innerHTML = Object.keys(d).reverse().map(k => `
                <div class="insta-post">
                    <div class="insta-header"><div class="profile-img" style="width:25px; height:25px; background-image:url('${userProfiles[d[k].u]||''}')"></div>${d[k].u}</div>
                    <div class="insta-img" style="background-image:url('${d[k].img}')"></div>
                    <div class="insta-body"><span onclick="db.ref('gal_final/${k}').remove()" style="cursor:pointer; color:gray;">ì‚­ì œ</span></div>
                </div>`).join('');
        });
    }

    function addBk() { const t=document.getElementById('bk-t').value, d=document.getElementById('bk-d').value, st=document.getElementById('bk-st').value; if(t) db.ref('bk_final').push({t, d, st, u:currentUser}); }
    function renderBk() {
        db.ref('bk_final').on('value', s => {
            const d=s.val(); const div=document.getElementById('bk-list'); if(!div||!d) {div.innerHTML=""; return;}
            div.innerHTML = Object.keys(d).reverse().map(k => `<div class="book-item">
                <b>ğŸ“– ${d[k].t}</b><br><small>${d[k].st} | ${d[k].d} (${d[k].u})</small>
                <span style="float:right; cursor:pointer;" onclick="db.ref('bk_final/${k}').remove()">Ã—</span></div>`).join('');
        });
    }

    let selD = "";
    function renderCal() {
        db.ref('cal_final').on('value', s => {
            const data=s.val()||{}; let h="";
            for(let i=1; i<=31; i++) {
                const k=`2024-10-${i}`;
                h += `<div class="cal-day" onclick="selD='${k}'; document.getElementById('cal-ctrl').style.display='block';">${i}<div style="text-align:center; font-size:1.5rem;">${data[k]||''}</div></div>`;
            }
            document.getElementById('cal-list').innerHTML = h;
        });
    }
    function saveCal(e) { if(selD) db.ref('cal_final/'+selD).set(e); }

    function addBgm() { const v=document.getElementById('bgm-in').value; const id=v.includes('v=')?v.split('v=')[1].split('&')[0]:v; if(id) db.ref('bgm_vfinal').push({id}); }
    function renderBgm() {
        db.ref('bgm_vfinal').on('value', s => {
            const d=s.val(); const div=document.getElementById('bgm-list'); if(!div||!d) return;
            div.innerHTML = Object.keys(d).map(k=>`<div style="padding:10px; border-bottom:1px solid #333;">ğŸµ ${d[k].id} <span style="float:right; color:red; cursor:pointer;" onclick="db.ref('bgm_vfinal/${k}').remove()">ì‚­ì œ</span></div>`).join('');
        });
    }

    let tempPfData = "";
    function prePf(i) { if(i.files[0]) { const r=new FileReader(); r.onload=e=>{ document.getElementById('pf-pre').style.backgroundImage=`url('${e.target.result}')`; tempPfData=e.target.result; }; r.readAsDataURL(i.files[0]); } }
    function savePf() { if(tempPfData) db.ref('profiles/'+currentUser).set(tempPfData).then(()=>alert("í”„ë¡œí•„ ì €ì¥ë¨")); }

    function closeModal() { document.getElementById('main-modal').style.display = 'none'; }
</script>
</body>
</html>om/embed/${id}?autoplay=1&loop=1&playlist=${id}" frameborder="0" allow="autoplay"></iframe>`;
        });
    }
</script>
</body>
</html>