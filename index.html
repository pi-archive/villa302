<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Villa 302: The Archive</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Pen+Script&family=Noto+Serif+KR:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <style>
        :root { --neon-red: #ff3131; --neon-green: #39ff14; --hk-gold: #ffd700; --msg-blue: #007aff; --msg-gray: #e9e9eb; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: #000; color: white; font-family: -apple-system, sans-serif; overflow: hidden; }
        
        #entry-page { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: url('villa interior.png') no-repeat center center/cover; z-index: 50000; display: flex; justify-content: center; align-items: center; }
        #stage { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100vw; height: 66.67vw; max-width: 150vh; max-height: 100vh; background: url('villa.png') no-repeat center center/contain; background-color: #000; }

        #sitemap-btn { position: fixed; top: 25px; left: 25px; width: 50px; height: 50px; background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3); color: white; cursor: pointer; z-index: 1100; border-radius: 12px; display: none; align-items: center; justify-content: center; font-size: 1.2rem; }
        #user-indicator { position: fixed; top: 25px; right: 25px; padding: 12px 25px; border: 2px solid var(--neon-green); border-radius: 30px; color: var(--neon-green); font-weight: bold; z-index: 1000; background: rgba(0,0,0,0.85); display: none; cursor: pointer; }

        .target { position: absolute; cursor: pointer; z-index: 10; }
        .wall-pos { top: 18%; left: 50%; width: 15%; height: 35%; } 
        .movie-pos { top: 8%; left: 63%; width: 20%; height: 15%; } 
        .cal-pos { top: 45%; left: 74%; width: 8%; height: 20%; } 
        .diary-pos { top: 52%; left: 57%; width: 13%; height: 8%; } 
        .photo-pos { top: 25%; left: 72%; width: 10%; height: 20%; } 
        .lib-pos { top: 35%; left: 35%; width: 12%; height: 25%; } 
        .exit-pos { top: 15%; left: 91%; width: 9%; height: 75%; } 

        .lock-box { background: rgba(0,0,0,0.95); padding: 30px; border-radius: 20px; border: 2px solid var(--neon-red); width: 300px; text-align: center; }
        .user-sel { flex:1; padding:12px; background:#111; color:white; border:1px solid #444; cursor:pointer; }
        .user-sel.active { border: 2px solid var(--neon-green) !important; color: var(--neon-green) !important; }
        .pw-screen { font-size: 2.2rem; color: var(--neon-red); margin-bottom: 20px; letter-spacing: 10px; background: #000; padding: 10px; border: 1px solid #333; height: 50px; }
        .keypad { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .key { padding: 20px; background: #111; border: 1px solid #333; cursor: pointer; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; justify-content: center; align-items: center; }
        .modal-inner { background: #1c1c1e; width: 90%; max-width: 750px; height: 85vh; border-radius: 25px; padding: 30px; overflow-y: auto; position: relative; color: white; }
        .close-btn { position: absolute; top: 20px; right: 25px; cursor: pointer; font-size: 2.5rem; color: #8e8e93; }

        .diary-theme { background: #fff !important; color: #000 !important; }
        .msg-date-center { text-align: center; font-size: 0.75rem; color: #8e8e93; margin: 20px 0 10px 0; font-weight: 600; }
        .diary-row { display: flex; margin-bottom: 15px; align-items: flex-end; width: 100%; }
        .profile-pic { width: 40px; height: 40px; border-radius: 14px; background-size: cover; background-position: center; margin: 0 10px; border: 1px solid #ddd; background-color: #eee; flex-shrink: 0; }
        .bubble { max-width: 65%; padding: 12px 16px; border-radius: 20px; font-size: 0.95rem; line-height: 1.4; position: relative; }
        .bubble.mine { background: var(--msg-blue); color: #fff; border-bottom-right-radius: 4px; }
        .bubble.yours { background: var(--msg-gray); color: #000; border-bottom-left-radius: 4px; }
        .diary-actions { font-size: 0.7rem; opacity: 0.6; margin-top: 5px; display: flex; gap: 8px; cursor: pointer; }

        .bookshelf-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(40px, 1fr)); gap: 8px; padding: 20px; background: #3d2b1f; border-radius: 8px; border-bottom: 15px solid #2a1d15; box-shadow: inset 0 -10px 20px rgba(0,0,0,0.5); }
        .book-spine { width: 35px; height: 140px; background: #5a3e2b; color: #ddd; writing-mode: vertical-rl; padding: 10px 4px; cursor: pointer; border-left: 4px solid rgba(255,255,255,0.2); font-size: 0.8rem; text-align: center; transition: 0.2s; overflow: hidden; border-radius: 2px; font-family: 'Noto Serif KR', serif; }
        .book-spine:hover { transform: translateY(-15px) scale(1.05); filter: brightness(1.3); z-index: 5; }
        
        .movie-card { background: #2c2c2e; padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #3a3a3c; }
        .movie-reply-area { background: rgba(0,0,0,0.2); border-radius: 10px; padding: 10px; margin-top: 10px; font-size: 0.85rem; }

        .flyer { position: absolute; background: #fffce0; color: #333; padding: 15px; width: 120px; min-height: 140px; box-shadow: 5px 5px 15px rgba(0,0,0,0.3); font-family: 'Nanum Pen Script', cursive; font-size: 1.3rem; border: 1px solid #ddd; }
        .flyer-x { position: absolute; top: 2px; right: 5px; cursor: pointer; font-family: sans-serif; font-size: 0.8rem; color: #999; }
        .flyer-fringe { position: absolute; bottom: 0; left: 0; width: 100%; height: 20px; display: flex; justify-content: space-around; }
        .fringe-bit { width: 1px; height: 100%; background: rgba(0,0,0,0.1); }

        .cal-container { background: #fff; color: #333; border-radius: 15px; padding: 20px; }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; font-weight: bold; font-size: 1.2rem; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; background: #eee; border: 1px solid #eee; }
        .cal-day-label { background: #f8f8f8; padding: 10px; text-align: center; font-size: 0.8rem; font-weight: bold; }
        .cal-cell { background: #fff; min-height: 80px; padding: 5px; position: relative; cursor: pointer; transition: 0.2s; }
        .cal-cell:hover { background: #f0f7ff; }
        .cal-cell.selected { border: 2px solid var(--msg-blue); z-index: 10; }
        .cal-date-num { font-size: 0.8rem; font-weight: bold; color: #999; }
        .cal-cell.today { background: #fffde7; }
        .cal-content { margin-top: 5px; text-align: center; }
        .cal-memo { font-size: 0.7rem; color: #666; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; line-height: 1.2; }

        #cal-editor { margin-top: 20px; padding: 20px; background: #f9f9f9; border-radius: 15px; border: 1px solid #ddd; display: none; }
        .emo-scroll-box { display: flex; gap: 10px; overflow-x: auto; padding: 10px 0; margin-bottom: 15px; }
        .emo-item { flex: 0 0 auto; width: 70px; text-align: center; cursor: pointer; padding: 10px; border-radius: 10px; border: 1px solid #eee; background: white; transition: 0.2s; }
        .emo-item.active { border: 2px solid var(--msg-blue); background: #f0f7ff; }
        .emo-icon { font-size: 1.5rem; display: block; margin-bottom: 5px; }
        .emo-label { font-size: 0.7rem; color: #666; }

        .btn-action { background: var(--msg-blue); color: white; border: none; padding: 12px; border-radius: 10px; cursor: pointer; width: 100%; font-weight: bold; margin-top: 10px; }
        textarea, input, select { width: 100%; padding: 12px; background: #2c2c2e; border: 1px solid #3a3a3c; color: white; border-radius: 10px; box-sizing: border-box; margin-bottom: 8px; }
        .insta-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; }
        .insta-item { aspect-ratio: 1; background-size: cover; background-position: center; cursor: pointer; border-radius: 4px; }
    </style>
</head>
<body onkeydown="handleGlobalKey(event)">

<div id="bgm-container"></div>
<div id="sitemap-btn" onclick="openTab('sitemap')">‚ò∞</div>
<div id="user-indicator" onclick="openTab('profile')">ACCESS: <span id="active-user"></span></div>

<div id="entry-page">
    <div class="lock-box">
        <div style="display:flex; gap:10px; margin-bottom:20px;">
            <button onclick="selectUser('ÌèâÌôî','1231')" id="btn-ÌèâÌôî" class="user-sel">ÌèâÌôî</button>
            <button onclick="selectUser('Ïù∏Ï≤†','0526')" id="btn-Ïù∏Ï≤†" class="user-sel">Ïù∏Ï≤†</button>
        </div>
        <div id="pw-disp" class="pw-screen">----</div>
        <div class="keypad">
            <script>for(let i=1; i<=9; i++) document.write(`<div class="key" onclick="pressKey('${i}')">${i}</div>`);</script>
            <div class="key" onclick="inputPw=''">C</div>
            <div class="key" onclick="pressKey('0')">0</div>
            <div class="key" onclick="checkPw()" style="background:var(--neon-red)">E</div>
        </div>
    </div>
</div>

<div id="stage">
    <div class="target wall-pos" onclick="openTab('wall')"></div>
    <div class="target movie-pos" onclick="openTab('movie')"></div>
    <div class="target cal-pos" onclick="openTab('calendar')"></div>
    <div class="target diary-pos" onclick="openTab('diary')"></div>
    <div class="target photo-pos" onclick="openTab('gallery')"></div>
    <div class="target lib-pos" onclick="openTab('library')"></div>
    <div class="target exit-pos" onclick="exitRoom()"></div>
</div>

<div id="main-modal" class="modal">
    <div class="modal-inner" id="modal-box">
        <span class="close-btn" onclick="closeModal()">&times;</span>
        <div id="modal-content"></div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyDLTGv4Z3zJUseuKw1acvHHwPzooZhXodc",
        authDomain: "villa302.firebaseapp.com",
        databaseURL: "https://villa302-default-rtdb.firebaseio.com",
        projectId: "villa302",
        storageBucket: "villa302.firebasestorage.app",
        messagingSenderId: "166700659009",
        appId: "1:166700659009:web:18c2872914aab8b4bbf1c0",
        measurementId: "G-81FF5SDS0D"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = "", targetPw = "", inputPw = "";
    let currentCalDate = new Date();
    let selectedCalKey = "";
    let selectedEmo = "üè†";
    let userProfiles = {}; 

    function handleGlobalKey(e) { 
        if (e.key === "Escape") closeModal(); 
        if (document.getElementById('entry-page').style.display !== 'none') {
            if (e.key >= '0' && e.key <= '9') pressKey(e.key);
            else if (e.key === 'Enter') checkPw();
        }
    }
    function selectUser(u, p) { 
        currentUser = u; targetPw = p; inputPw = ""; 
        document.querySelectorAll('.user-sel').forEach(b => b.classList.remove('active'));
        document.getElementById('btn-'+u).classList.add('active');
        updatePwDisp(); 
    }
    function pressKey(n) { if(inputPw.length < 4) inputPw += n; updatePwDisp(); }
    function updatePwDisp() { document.getElementById('pw-disp').innerText = "*".repeat(inputPw.length) || "----"; }
    function checkPw() { 
        if(inputPw === targetPw) { 
            document.getElementById('entry-page').style.display='none'; 
            document.getElementById('user-indicator').style.display='block'; 
            document.getElementById('sitemap-btn').style.display='flex'; 
            document.getElementById('active-user').innerText = currentUser;
            syncProfiles(); 
            loadBGM(); 
        } else { alert("ÏïîÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§."); inputPw=""; updatePwDisp(); } 
    }
    function exitRoom() { if(confirm("Î°úÍ∑∏ÏïÑÏõÉ ÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) location.reload(); }

    function syncProfiles() {
        db.ref('profiles').on('value', (snapshot) => {
            userProfiles = snapshot.val() || {};
        });
    }

    const tabs = {
        sitemap: () => `<h3>SITEMAP</h3><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <div style="background:#333; padding:20px; border-radius:10px; cursor:pointer;" onclick="openTab('diary')">üìî ÏùºÍ∏∞Ïû•</div>
            <div style="background:#333; padding:20px; border-radius:10px; cursor:pointer;" onclick="openTab('movie')">üé¨ ÏòÅÌôî</div>
            <div style="background:#333; padding:20px; border-radius:10px; cursor:pointer;" onclick="openTab('library')">üìö ÏÑúÏû¨</div>
            <div style="background:#333; padding:20px; border-radius:10px; cursor:pointer;" onclick="openTab('calendar')">üìÖ ÏùºÏ†ï</div>
            <div style="background:#333; padding:20px; border-radius:10px; cursor:pointer;" onclick="openTab('gallery')">üì∏ ÏÇ¨ÏßÑ</div>
            <div style="background:#333; padding:20px; border-radius:10px; cursor:pointer;" onclick="openTab('bgm')">üéµ BGM</div>
        </div>`,
        profile: () => `<h3>üë§ PROFILE SETTING</h3>
            <div style="text-align:center;">
                <div id="prof-preview" style="width:120px; height:120px; border-radius:20px; background:#444; margin:20px auto; background-size:cover; background-position:center; background-image:url('${userProfiles[currentUser] || ''}')"></div>
                <p><b>${currentUser}</b>ÎãòÏùò ÌîÑÎ°úÌïÑ</p>
                <input type="file" id="prof-input" accept="image/*" onchange="uploadProfile(this)" style="display:none">
                <button class="btn-action" onclick="document.getElementById('prof-input').click()">Ïù¥ÎØ∏ÏßÄ Î≥ÄÍ≤Ω</button>
            </div>`,
        diary: () => `<div class="diary-theme" style="height:100%; display:flex; flex-direction:column;">
            <div id="diary-chat" style="flex:1; overflow-y:auto; padding:15px; min-height:400px;"></div>
            <div style="padding:15px; border-top:1px solid #efeff4;">
                <textarea id="d-in" style="background:#f2f2f7; color:#000; height:60px;" placeholder="Ïò§ÎäòÏùò Ïù¥ÏïºÍ∏∞..."></textarea>
                <button class="btn-action" onclick="saveDiary()">Ï†ÑÏÜ°</button>
            </div></div>`,
        movie: () => `<h3>üé¨ MOVIE ARCHIVE</h3>
            <input id="m-title" placeholder="ÏòÅÌôî Ï†úÎ™©">
            <button class="btn-action" onclick="addMovie()">Ï∂îÍ∞Ä</button>
            <div id="movie-list" style="margin-top:20px;"></div>`,
        library: () => `<h3>üìö LIBRARY</h3>
            <button class="btn-action" onclick="writeBook()">+ ÏÉàÎ°úÏö¥ Í∏∞Î°ù</button>
            <div id="lib-shelf" class="bookshelf-grid" style="margin-top:20px;"></div>`,
        gallery: () => `<h3>üì∏ PHOTO ARCHIVE</h3>
            <input type="file" id="g-file" accept="image/*">
            <input id="g-desc" placeholder="ÏÇ¨ÏßÑ ÏÑ§Î™Ö">
            <button class="btn-action" onclick="uploadPhoto()">Îì±Î°ù</button>
            <div id="g-list" class="insta-grid" style="margin-top:20px;"></div>`,
        bgm: () => `<h3>üéµ BGM SETTING</h3>
            <input id="bgm-url" placeholder="Ïú†ÌäúÎ∏å URL">
            <button class="btn-action" onclick="setBGM()">Ï†ÅÏö©</button>`,
        calendar: () => `<h3>üìÖ CALENDAR</h3><div id="cal-render-area"></div>
            <div id="cal-editor">
                <p id="cal-edit-title" style="font-weight:bold;"></p>
                <div class="emo-scroll-box">${[{e:"üè†", l:"Ïßë"}, {e:"üöó", l:"Ï∂úÍ∑º"}, {e:"üêü", l:"Îç∞Ïù¥Ìä∏"}, {e:"‚≠ê", l:"ÏùºÏ†ï"}, {e:"üçï", l:"Ïô∏Ïãù"}, {e:"üé¨", l:"ÏòÅÌôî"}, {e:"üç∫", l:"Ïà†"}, {e:"ü§î", l:"ÏÉùÍ∞Å"}, {e:"ü•∞", l:"ÌñâÎ≥µ"}, {e:"üò≠", l:"Ïö∞Ïö∏"}].map(item => `<div class="emo-item" id="emo-${item.e}" onclick="selectEmo('${item.e}')"><span class="emo-icon">${item.e}</span><span class="emo-label">${item.l}</span></div>`).join('')}</div>
                <input id="cal-memo-in" style="background:white; color:black;" placeholder="Î©îÎ™®">
                <button class="btn-action" onclick="saveCal()">Ï†ÄÏû•</button>
            </div>`,
        wall: () => `<h3>üß± WALL</h3>
            <input id="w-in" placeholder="Î©îÏãúÏßÄ ÏûëÏÑ±">
            <button class="btn-action" onclick="addWall()">Ìè¨Ïä§Ìä∏Ïûá Î∂ôÏù¥Í∏∞</button>
            <div id="wall-board" style="height:450px; position:relative; background-color:#222; margin-top:20px; border-radius:15px; overflow:hidden; border:5px solid #333;"></div>`
    };

    function openTab(id) {
        const box = document.getElementById('modal-box');
        id === 'diary' ? box.classList.add('diary-theme') : box.classList.remove('diary-theme');
        document.getElementById('modal-content').innerHTML = tabs[id]();
        document.getElementById('main-modal').style.display = 'flex';
        
        if(id==='diary') loadDiary();
        if(id==='movie') loadMovies();
        if(id==='library') loadShelf();
        if(id==='gallery') loadGallery();
        if(id==='wall') loadWall();
        if(id==='calendar') renderCalendar();
    }
    function closeModal() { document.getElementById('main-modal').style.display = 'none'; }

    // [ÏùºÍ∏∞Ïû• Î≥¥ÏôÑ]
    function saveDiary() {
        const t = document.getElementById('d-in').value; if(!t) return;
        db.ref('diary_v2').push({ id: Date.now(), u: currentUser, t: t, d: new Date().toLocaleDateString(), reps: [] })
        .then(() => { 
            document.getElementById('d-in').value = "";
            // ÌååÏù¥Ïñ¥Î≤†Ïù¥Ïä§ .on()Ïù¥ ÏûêÎèô Í∞±Ïã†ÌïòÎØÄÎ°ú Ï∂îÍ∞Ä Î°úÏßÅ Î∂àÌïÑÏöî
        });
    }
    function loadDiary() {
        db.ref('diary_v2').on('value', (snapshot) => {
            const data = snapshot.val();
            const list = data ? Object.entries(data).map(([key, val]) => ({...val, firebaseKey: key})) : [];
            const chat = document.getElementById('diary-chat');
            if(!chat) return;
            let lastD = "";
            chat.innerHTML = list.map(i => {
                let dateHead = (i.d !== lastD) ? `<div class="msg-date-center">${i.d}</div>` : ""; lastD = i.d;
                const isMine = i.u === currentUser;
                const profImg = userProfiles[i.u] || ''; 
                return `${dateHead}
                <div class="diary-row" style="flex-direction:${isMine?'row-reverse':'row'}">
                    <div class="profile-pic" style="background-image:url('${profImg}')"></div>
                    <div class="bubble ${isMine?'mine':'yours'}">
                        <div>${i.t}</div>
                        <div class="diary-actions">
                            <span onclick="replyDiary('${i.firebaseKey}')">ÎåìÍ∏Ä</span>
                            ${isMine ? `<span onclick="delDiary('${i.firebaseKey}')">ÏÇ≠Ï†ú</span>` : ''}
                        </div>
                    </div>
                </div>
                <div style="font-size:0.75rem; padding:5px 60px; color:#666; text-align:${isMine?'right':'left'}">
                    ${i.reps ? Object.values(i.reps).map(r => `„Ñ¥ <b>${r.u}</b>: ${r.t}<br>`).join('') : ''}
                </div>`;
            }).join('');
            chat.scrollTop = chat.scrollHeight;
        });
    }
    function replyDiary(fKey) {
        const msg = prompt("ÎåìÍ∏Ä ÎÇ¥Ïö©:"); if(!msg) return;
        db.ref(`diary_v2/${fKey}/reps`).push({ u: currentUser, t: msg });
    }
    function delDiary(fKey) { if(confirm("ÏÇ≠Ï†úÌï†ÍπåÏöî?")) db.ref(`diary_v2/${fKey}`).remove(); }

    // [ÏòÅÌôî Î≥¥ÏôÑ]
    function addMovie() {
        const t = document.getElementById('m-title').value; if(!t) return;
        db.ref('movie_v2').push({ id: Date.now(), t: t, stars: { 'ÌèâÌôî': 0, 'Ïù∏Ï≤†': 0 }, replies: [] })
        .then(() => { document.getElementById('m-title').value = ""; });
    }
    function loadMovies() {
        db.ref('movie_v2').on('value', (snapshot) => {
            const data = snapshot.val();
            const list = data ? Object.entries(data).reverse() : [];
            const container = document.getElementById('movie-list');
            if(!container) return;
            container.innerHTML = list.map(([key, m]) => `
                <div class="movie-card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <b style="font-size:1.1rem;">${m.t}</b>
                        <span style="color:var(--neon-red); cursor:pointer; font-size:0.8rem;" onclick="delMovie('${key}')">ÏÇ≠Ï†ú</span>
                    </div>
                    <div style="margin:10px 0; color:var(--hk-gold); font-size:0.9rem;">
                        ÌèâÌôî: ${'‚òÖ'.repeat(m.stars['ÌèâÌôî']) || 'ÎØ∏Ï†ï'} | Ïù∏Ï≤†: ${'‚òÖ'.repeat(m.stars['Ïù∏Ï≤†']) || 'ÎØ∏Ï†ï'}
                    </div>
                    <div style="display:flex; gap:5px;">
                        <select onchange="rateMovie('${key}', this.value)" style="flex:2; font-size:0.8rem; padding:5px;">
                            <option value="0">Î≥ÑÏ†ê ÏÑ†ÌÉù</option><option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</option><option value="4">‚òÖ‚òÖ‚òÖ‚òÖ</option><option value="3">‚òÖ‚òÖ‚òÖ</option><option value="2">‚òÖ‚òÖ</option><option value="1">‚òÖ</option>
                        </select>
                        <button onclick="replyMovie('${key}')" style="flex:1; background:#444; color:white; border:none; border-radius:10px; cursor:pointer;">ÏΩîÎ©òÌä∏</button>
                    </div>
                    <div class="movie-reply-area">
                        ${m.replies ? Object.values(m.replies).map(r => `<div><b>${r.u}</b>: ${r.t}</div>`).join('') : 'ÏïÑÏßÅ Í∞êÏÉÅÌèâ ÏóÜÏùå'}
                    </div>
                </div>`).join('');
        });
    }
    function rateMovie(fKey, v) { db.ref(`movie_v2/${fKey}/stars/${currentUser}`).set(parseInt(v)); }
    function replyMovie(fKey) {
        const t = prompt("ÏΩîÎ©òÌä∏:"); if(!t) return;
        db.ref(`movie_v2/${fKey}/replies`).push({ u: currentUser, t: t });
    }
    function delMovie(fKey) { if(confirm("ÏÇ≠Ï†úÌï†ÍπåÏöî?")) db.ref(`movie_v2/${fKey}`).remove(); }

    // [ÏÑúÏû¨ Î≥¥ÏôÑ]
    function writeBook() {
        const t = prompt("Ï†úÎ™©:"); if(!t) return;
        const c = prompt("ÎÇ¥Ïö©:"); if(!c) return;
        const colors = ['#5a3e2b', '#3e5a2b', '#2b3e5a', '#5a2b2b', '#444'];
        db.ref('lib_v3').push({ id: Date.now(), t, c, color: colors[Math.floor(Math.random()*colors.length)] });
    }
    function loadShelf() {
        db.ref('lib_v3').on('value', (snapshot) => {
            const data = snapshot.val();
            const shelf = document.getElementById('lib-shelf');
            if(!shelf) return;
            shelf.innerHTML = data ? Object.entries(data).map(([key, b]) => `<div class="book-spine" style="background-color:${b.color}" onclick="viewBook('${key}')">${b.t}</div>`).join('') : '';
        });
    }
    function viewBook(fKey) {
        db.ref(`lib_v3/${fKey}`).once('value', (s) => {
            const b = s.val();
            document.getElementById('modal-content').innerHTML = `
                <div style="background:#fdfcf0; color:#333; padding:40px; border-left:15px solid ${b.color}; min-height:500px; font-family:'Noto Serif KR', serif;">
                    <h1 style="border-bottom:2px solid #333; padding-bottom:10px;">${b.t}</h1>
                    <div style="white-space:pre-wrap; font-size:1.1rem; line-height:2; margin-top:30px;">${b.c}</div>
                    <div style="margin-top:50px; text-align:right;">
                        <button onclick="openTab('library')" style="padding:10px 20px;">Î™©Î°ù</button>
                        <button onclick="delBook('${fKey}')" style="color:red; margin-left:10px;">ÏÇ≠Ï†ú</button>
                    </div>
                </div>`;
        });
    }
    function delBook(fKey) { if(confirm("ÏÇ≠Ï†úÌï†ÍπåÏöî?")) { db.ref(`lib_v3/${fKey}`).remove(); openTab('library'); } }

    // [Îã¥Î≤ºÎùΩ Î≥¥ÏôÑ]
    function addWall() {
        const t = document.getElementById('w-in').value; if(!t) return;
        db.ref('wall_v3').push({ id: Date.now(), t, x: Math.random()*75, y: Math.random()*65, rot: (Math.random()*10-5) });
        document.getElementById('w-in').value="";
    }
    function loadWall() {
        db.ref('wall_v3').on('value', (snapshot) => {
            const data = snapshot.val();
            const board = document.getElementById('wall-board');
            if(!board) return;
            board.innerHTML = data ? Object.entries(data).map(([key, w]) => `
                <div class="flyer" style="left:${w.x}%; top:${w.y}%; transform:rotate(${w.rot}deg);">
                    <span class="flyer-x" onclick="delWall('${key}')">‚úñ</span>${w.t}
                    <div class="flyer-fringe">${Array(10).fill('<div class="fringe-bit"></div>').join('')}</div>
                </div>`).join('') : '';
        });
    }
    function delWall(fKey) { db.ref(`wall_v3/${fKey}`).remove(); }

    // [Ï∫òÎ¶∞Îçî Î≥¥ÏôÑ]
    function renderCalendar() {
        const year = currentCalDate.getFullYear();
        const month = currentCalDate.getMonth();
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        db.ref('cal_v3').on('value', (snapshot) => {
            const dbData = snapshot.val() || {};
            let html = `<div class="cal-container"><div class="cal-header"><span onclick="moveMonth(-1)" style="cursor:pointer;">‚óÄ</span><span>${year}ÎÖÑ ${month + 1}Ïõî</span><span onclick="moveMonth(1)" style="cursor:pointer;">‚ñ∂</span></div><div class="cal-grid">${['Ïùº','Ïõî','Ìôî','Ïàò','Î™©','Í∏à','ÌÜ†'].map(d => `<div class="cal-day-label">${d}</div>`).join('')}`;
            for(let i=0; i<firstDay; i++) html += `<div class="cal-cell" style="background:#f9f9f9"></div>`;
            for(let d=1; d<=daysInMonth; d++) {
                const key = `${year}-${month+1}-${d}`;
                const data = dbData[key] || { emo: '', memo: '' };
                html += `<div class="cal-cell" id="cell-${key}" onclick="editCal('${key}', ${d})"><div class="cal-date-num">${d}</div><div class="cal-content"><div style="font-size:1.2rem;">${data.emo}</div><div class="cal-memo">${data.memo}</div></div></div>`;
            }
            const area = document.getElementById('cal-render-area');
            if(area) area.innerHTML = html + `</div></div>`;
        });
    }
    function moveMonth(dir) { currentCalDate.setMonth(currentCalDate.getMonth() + dir); renderCalendar(); }
    function editCal(key, day) {
        selectedCalKey = key;
        db.ref(`cal_v3/${key}`).once('value', (s) => {
            const cur = s.val() || { emo: 'üè†', memo: '' };
            document.getElementById('cal-editor').style.display = 'block';
            document.getElementById('cal-edit-title').innerText = `${day}Ïùº Í∏∞Î°ù`;
            document.getElementById('cal-memo-in').value = cur.memo;
            selectEmo(cur.emo || 'üè†');
            // ÏÑ†ÌÉùÎêú ÏÖÄ Í∞ïÏ°∞ (Ïù¥Ï†Ñ ÏÑ†ÌÉù Ìï¥Ï†ú ÌõÑ ÌòÑÏû¨ ÏÑ†ÌÉù Ï∂îÍ∞Ä)
            document.querySelectorAll('.cal-cell').forEach(c => c.classList.remove('selected'));
            document.getElementById('cell-'+key).classList.add('selected');
        });
    }
    function selectEmo(emo) { selectedEmo = emo; document.querySelectorAll('.emo-item').forEach(el => el.classList.remove('active')); document.getElementById('emo-'+emo).classList.add('active'); }
    function saveCal() { 
        if(!selectedCalKey) return; 
        db.ref(`cal_v3/${selectedCalKey}`).set({ emo: selectedEmo, memo: document.getElementById('cal-memo-in').value })
        .then(() => { 
            alert("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§."); 
            document.getElementById('cal-editor').style.display = 'none'; // Ï†ÄÏû• ÌõÑ ÏûÖÎ†•Ï∞Ω Îã´Í∏∞
        }); 
    }

    // [Í∞§Îü¨Î¶¨/BGM/ÌîÑÎ°úÌïÑ Î≥¥ÏôÑ]
    function uploadProfile(input) {
        const file = input.files[0]; if(!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const base64Img = e.target.result;
            db.ref('profiles/' + currentUser).set(base64Img).then(() => {
                document.getElementById('prof-preview').style.backgroundImage = `url(${base64Img})`;
                alert("ÌîÑÎ°úÌïÑÏù¥ Î≥ÄÍ≤ΩÎêòÏóàÏäµÎãàÎã§.");
            });
        };
        reader.readAsDataURL(file);
    }
    function uploadPhoto() {
        const file = document.getElementById('g-file').files[0], desc = document.getElementById('g-desc').value;
        if(!file) return;
        const r = new FileReader();
        r.onload = (e) => { 
            db.ref('gallery_v2').push({ id: Date.now(), img: e.target.result, desc })
            .then(() => { alert("ÏÇ¨ÏßÑÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§."); document.getElementById('g-desc').value = ""; });
        };
        r.readAsDataURL(file);
    }
    function loadGallery() {
        db.ref('gallery_v2').on('value', (snapshot) => {
            const data = snapshot.val();
            const list = data ? Object.values(data).reverse() : [];
            const container = document.getElementById('g-list');
            if(!container) return;
            container.innerHTML = list.map(p => `<div class="insta-item" style="background-image:url('${p.img}')" onclick="alert('${p.desc}')"></div>`).join('');
        });
    }
    function setBGM() {
        const url = document.getElementById('bgm-url').value; if(!url) return;
        let id = url.includes('v=') ? url.split('v=')[1].split('&')[0] : url.split('/').pop();
        db.ref('settings/bgm').set(id).then(() => { alert("BGM Ï†ÅÏö©Îê®"); });
    }
    function loadBGM() {
        db.ref('settings/bgm').on('value', (s) => {
            const id = s.val();
            if(id) document.getElementById('bgm-container').innerHTML = `<iframe width="0" height="0" src="https://www.youtube.com/embed/${id}?autoplay=1&loop=1&playlist=${id}" frameborder="0" allow="autoplay"></iframe>`;
        });
    }
</script>
</body>
</html>